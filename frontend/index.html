<script>
document.addEventListener('DOMContentLoaded', function() {
    // Ambil user session dari backend
    fetch('/api/session', { credentials: 'same-origin' })
        .then(res => res.json())
        .then(data => {
            if (data.success && data.user) {
                window.currentUser = data.user;
                var sidebarUsername = document.getElementById('sidebarUsername');
                var sidebarRole = document.getElementById('sidebarRole');

                // Helper: normalize role value from DB (handles 'admin', 'administrator', numeric flags, booleans, etc.)
                function normalizeRole(value) {
                    if (value === null || value === undefined) return '';
                    return String(value).trim().toLowerCase();
                }

                function isAdminRole(value) {
                    const r = normalizeRole(value);
                    return ['admin', 'administrator', 'superadmin', 'owner', '1', 'true', 't'].includes(r);
                }

                function prettyRoleLabel(value) {
                    const r = normalizeRole(value);
                    if (isAdminRole(r)) return 'Administrator';
                    if (['operator', 'staff', 'pegawai', 'user'].includes(r)) return 'Staff';
                    if (!r) return '-';
                    // Fallback: capitalize first letter
                    return r.charAt(0).toUpperCase() + r.slice(1);
                }

                if (sidebarUsername) sidebarUsername.textContent = window.currentUser.name || window.currentUser.username || '-';
                if (sidebarRole) sidebarRole.textContent = prettyRoleLabel(window.currentUser.role);

                // populate header dropdown (if present)
                try {
                    const hdName = document.getElementById('headerDropdownName');
                    const hdRole = document.getElementById('headerDropdownRole');
                    if (hdName) hdName.textContent = window.currentUser.name || window.currentUser.username || 'User';
                    if (hdRole) hdRole.textContent = prettyRoleLabel(window.currentUser.role);
                } catch (e) {}

                // Set avatar image if provided by session; otherwise show initial (for both header and sidebar)
                try {
                    const headerImg = document.getElementById('headerAvatarImg');
                    const headerInitial = document.getElementById('headerAvatarInitial');
                    const sidebarImg = document.getElementById('sidebarAvatarImg');
                    const sidebarInitial = document.getElementById('sidebarAvatarInitial');
                    const nameOrUser = window.currentUser.name || window.currentUser.username || '-';
                    const photo = window.currentUser.photo ? String(window.currentUser.photo || '') : '';
                    let src = '';
                    if (photo) {
                        src = photo;
                        if (!src.startsWith('/') && !/^https?:\/\//i.test(src)) src = '/img/' + src;
                    }
                    // Header avatar
                    if (headerImg) {
                        if (src) { headerImg.src = src; headerImg.classList.remove('hidden'); }
                        else { headerImg.src = ''; headerImg.classList.add('hidden'); }
                    }
                    if (headerInitial) {
                        headerInitial.textContent = (nameOrUser && nameOrUser.length > 0) ? nameOrUser.charAt(0).toUpperCase() : 'A';
                        if (src) headerInitial.classList.add('hidden'); else headerInitial.classList.remove('hidden');
                    }
                    // Sidebar avatar (bottom)
                    if (sidebarImg) {
                        if (src) { sidebarImg.src = src; sidebarImg.classList.remove('hidden'); }
                        else { sidebarImg.src = ''; sidebarImg.classList.add('hidden'); }
                    }
                    if (sidebarInitial) {
                        sidebarInitial.textContent = (nameOrUser && nameOrUser.length > 0) ? nameOrUser.charAt(0).toUpperCase() : 'A';
                        if (src) sidebarInitial.classList.add('hidden'); else sidebarInitial.classList.remove('hidden');
                    }
                } catch (e) {
                    // silent
                }

                // Menu user visibility (use normalized admin check)
                const navUserBtn = document.getElementById('nav-users');
                const userSection = document.getElementById('users');
                if (isAdminRole(window.currentUser.role)) {
                    if (navUserBtn) navUserBtn.style.display = '';
                    if (userSection) userSection.style.display = '';
                } else {
                    if (navUserBtn) navUserBtn.style.display = 'none';
                    if (userSection) userSection.style.display = 'none';
                }
            } else {
                // Belum login, tampilkan -
                var sidebarUsername = document.getElementById('sidebarUsername');
                var sidebarRole = document.getElementById('sidebarRole');
                if (sidebarUsername) sidebarUsername.textContent = '-';
                if (sidebarRole) sidebarRole.textContent = '-';
                    try { const hdName = document.getElementById('headerDropdownName'); const hdRole = document.getElementById('headerDropdownRole'); if (hdName) hdName.textContent = '-'; if (hdRole) hdRole.textContent = '-'; } catch(e) {}
            }
        });
    // ...existing code...
});
</script>
<!DOCTYPE html>
<html lang="id">
<head>
<script>
async function login(event) {
    event.preventDefault();
    const username = document.getElementById('loginUsername').value;
    const password = document.getElementById('loginPassword').value;
    try {
        const response = await fetch('/api/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'same-origin',
            body: JSON.stringify({ username, password })
        });
        const result = await response.json();
        if (result.success && result.user) {
                // Server stored session; reload to let session-based fetch update the UI
                window.location.href = '/index.html';
        } else {
            alert('Login gagal: ' + (result.message || 'Username/password salah'));
        }
    } catch (err) {
        alert('Login error: ' + err.message);
    }
}
</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Service HP - Management System</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Suppress Tailwind CDN production warning
        (function() {
            const originalWarn = console.warn;
            console.warn = function(...args) {
                const message = args[0];
                if (typeof message === 'string' && message.includes('should not be used in production')) {
                    return;
                }
                originalWarn.apply(console, args);
            };
        })();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- DataTables CSS & JS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap');
        body { 
            font-family: 'Inter', sans-serif; 
            font-size: 14px;
        }
        
        /* Loading States */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        
        .loading-spinner {
            background: white;
            padding: 2rem;
            border-radius: 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e5e7eb;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Minimalist DataTables Styling */
        .dataTables_wrapper {
            font-family: 'Inter', sans-serif;
            padding: 0;
        }
        
        .dataTables_wrapper .dataTables_length,
        .dataTables_wrapper .dataTables_filter {
            margin-bottom: 1rem;
        }
        
        .dataTables_wrapper .dataTables_length {
            float: left;
        }
        
        .dataTables_wrapper .dataTables_filter {
            float: right;
        }
        
        .dataTables_wrapper .dataTables_filter label,
        .dataTables_wrapper .dataTables_length label {
            font-weight: 500;
            color: #374151;
            font-size: 0.875rem;
        }
        
        .dataTables_filter input {
            padding: 0.5rem 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            width: 250px;
            margin-left: 0.5rem;
            transition: all 0.2s;
        }
        
        .dataTables_filter input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .dataTables_length select {
            padding: 0.5rem 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            margin-left: 0.5rem;
            background-color: white;
        }
        
        .dataTables_wrapper .dataTables_info {
            clear: both;
            float: left;
            padding-top: 1rem;
            font-size: 0.875rem;
            color: #6b7280;
        }
        
        .dataTables_wrapper .dataTables_paginate {
            float: right;
            text-align: right;
            padding-top: 1rem;
        }
        
        .dataTables_paginate .paginate_button {
            display: inline-block;
            padding: 0.5rem 0.75rem;
            margin-left: 0.25rem;
            font-size: 0.875rem;
            border: 1px solid #e5e7eb;
            border-radius: 0.375rem;
            color: #374151;
            text-decoration: none;
            min-width: 40px;
            text-align: center;
            transition: all 0.2s;
        }
        
        .dataTables_paginate .paginate_button:hover {
            background-color: #f3f4f6;
            border-color: #d1d5db;
        }
        
        .dataTables_paginate .paginate_button.current {
            background-color: #3b82f6;
            border-color: #3b82f6;
            color: white;
        }
        
        .dataTables_paginate .paginate_button.current:hover {
            background-color: #2563eb;
        }
        
        /* Clean Table Styling */
        table.dataTable {
            border-collapse: separate;
            border-spacing: 0;
            width: 100%;
            margin: 0;
            font-size: 0.875rem;
            border-radius: 0.5rem;
            overflow: hidden;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            min-width: 0; /* allow responsive shrink */
        }
        
        .table-scroll-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            border-radius: 0.5rem;
            width: 100%;
            display: block;
        }

        /* Ensure stocks detail table distributes columns evenly and doesn't look empty */
        #stocksDetailTable {
            width: 100% !important;
            table-layout: fixed; /* distribute column widths evenly */
        }

        #stocksDetailTable th, #stocksDetailTable td {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            vertical-align: middle;
        }

        /* Small responsive adjustments for the detail table */
        @media (max-width: 768px) {
            #stocksDetailTable th, #stocksDetailTable td {
                white-space: normal; /* allow wrapping on small screens */
            }
        }
        
        .table-scroll-container::-webkit-scrollbar {
            height: 8px;
        }
        
        .table-scroll-container::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 4px;
        }
        
        .table-scroll-container::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        
        .table-scroll-container::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        
        table.dataTable thead th {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-bottom: 2px solid #e2e8f0;
            padding: 1rem 0.75rem;
            font-weight: 600;
            font-size: 0.875rem;
            color: #1e293b;
            text-align: left;
            white-space: nowrap;
            position: relative;
        }
        
        table.dataTable thead th:first-child {
            border-top-left-radius: 0.5rem;
        }
        
        table.dataTable thead th:last-child {
            border-top-right-radius: 0.5rem;
        }
        
        table.dataTable tbody td {
            padding: 0.875rem 0.75rem;
            border-bottom: 1px solid #f1f5f9;
            font-size: 0.875rem;
            vertical-align: middle;
            background-color: white;
        }
        
        table.dataTable tbody tr:hover td {
            background-color: #f8fafc;
        }
        
        table.dataTable tbody tr:last-child td:first-child {
            border-bottom-left-radius: 0.5rem;
        }
        
        table.dataTable tbody tr:last-child td:last-child {
            border-bottom-right-radius: 0.5rem;
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .dataTables_filter input {
                width: 180px;
            }
            
            table.dataTable {
                min-width: 0;
                font-size: 0.8rem;
                table-layout: auto;
                word-break: break-word;
            }
            
            table.dataTable thead th,
            table.dataTable tbody td {
                padding: 0.75rem 0.5rem;
                font-size: 0.8rem;
                white-space: nowrap;
            }
            
            .dataTables_wrapper .dataTables_length,
            .dataTables_wrapper .dataTables_filter {
                float: none;
                text-align: center;
                margin-bottom: 0.75rem;
            }
            
            .dataTables_wrapper .dataTables_info,
            .dataTables_wrapper .dataTables_paginate {
                float: none;
                text-align: center;
                padding-top: 0.75rem;
            }
            
            .table-scroll-container::after {
                content: '← Geser untuk melihat lebih banyak →';
                display: block;
                text-align: center;
                font-size: 0.75rem;
                color: #6b7280;
                padding: 0.5rem;
                background: #f9fafb;
                border-top: 1px solid #e5e7eb;
            }
        }
        
        @media (max-width: 480px) {
            table.dataTable {
                min-width: 500px;
                font-size: 0.75rem;
            }
            
            table.dataTable thead th,
            table.dataTable tbody td {
                padding: 0.5rem 0.375rem;
                font-size: 0.75rem;
            }
            
            .action-btn {
                width: 1.75rem;
                height: 1.75rem;
                font-size: 0.75rem;
            }
        }
        
        /* Beautiful Action buttons */
        .action-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 2rem;
            height: 2rem;
            border-radius: 0.375rem;
            transition: all 0.2s;
            text-decoration: none;
            font-size: 0.875rem;
            margin: 0 0.125rem;
            border: none;
            cursor: pointer;
            font-weight: 500;
        }
        
        .action-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        
        .action-btn.print {
            background: linear-gradient(135deg, #ddd6fe 0%, #c4b5fd 100%);
            color: #5b21b6;
        }
        
        .action-btn.print:hover {
            background: linear-gradient(135deg, #c4b5fd 0%, #a78bfa 100%);
        }
        
        .action-btn.success {
            background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
            color: #166534;
        }
        
        .action-btn.success:hover {
            background: linear-gradient(135deg, #bbf7d0 0%, #86efac 100%);
        }
        
        .action-btn.danger {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            color: #991b1b;
        }
        
        .action-btn.danger:hover {
            background: linear-gradient(135deg, #fecaca 0%, #fca5a5 100%);
        }
        
        .action-btn.edit {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            color: #92400e;
        }
        
        .action-btn.edit:hover {
            background: linear-gradient(135deg, #fde68a 0%, #fcd34d 100%);
        }

        /* Ensure action buttons are clickable even if overlays exist */
        .action-btn {
            position: relative;
            z-index: 60; /* modest z-index so buttons are clickable but modals stay on top */
            pointer-events: auto;
        }

        /* Remove forced high z-index on table cells to avoid covering modals */
        #usersTable td, #usersTable th {
            position: relative;
            z-index: auto;
            pointer-events: auto;
        }

        /* Ensure modal containers appear above page content and overlays */
        /* Apply to any div whose id ends with 'Modal' */
        div[id$="Modal"] {
            z-index: 11000;
        }
        
        /* Beautiful Status badges */
        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            white-space: nowrap;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }
        
        .status-badge.paid {
            background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
            color: #166534;
            border: 1px solid #86efac;
        }
        
        .status-badge.unpaid {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            color: #991b1b;
            border: 1px solid #fca5a5;
        }
        
        .status-badge.member {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            color: #1e40af;
            border: 1px solid #93c5fd;
        }
        
        .status-badge.regular {
            background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
            color: #374151;
            border: 1px solid #d1d5db;
        }

        .status-badge.stock {
            background: linear-gradient(135deg, #ecfdf5 0%, #bbf7d0 100%);
            color: #065f46;
            border: 1px solid #86efac;
        }

        /* Plain source label (no oval background) */
        .source-label {
            display: inline-block;
            padding: 0;
            border: none;
            background: transparent;
            color: #374151; /* neutral text color */
            font-weight: 400;
            text-transform: none;
            border-radius: 0;
            font-size: 0.875rem;
        }

        /* Allow certain table cells to wrap and break long words for better responsive fit */
        .wrap-cell {
            white-space: normal !important;
            word-break: break-word !important;
            vertical-align: top !important;
        }

        /* Reduce header padding slightly to fit more content */
        table.dataTable thead th {
            padding: 0.6rem 0.5rem;
        }

        table.dataTable tbody td {
            padding: 0.5rem 0.5rem;
        }
        
        .status-badge.active {
            background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
            color: #166534;
            border: 1px solid #86efac;
        }
        
        .section {
            display: none;
        }
        .section.active {
            display: block;
        }
        
        /* Enhanced Card styling */
        .card {
            background: white;
            border-radius: 1rem;
            border: 1px solid #f1f5f9;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: all 0.2s;
        }
        
        .card:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        
        .table-container {
            background: white;
            border-radius: 1rem;
            border: 1px solid #f1f5f9;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            overflow: hidden;
        }
        
        .table-header {
            padding: 1.5rem;
        }

        /* Minimal select used inside Add Service modal */
        .minimal-select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background: transparent;
            border: 0;
            border-bottom: 1px solid #e5e7eb;
            padding: 0.4rem 0.25rem;
            font-size: 0.95rem;
            color: #111827;
            border-radius: 0;
            outline: none;
        }

        /* ensure dropdown still shows caret on the right using background-image */
        .minimal-select { background-image: linear-gradient(45deg, transparent 50%, #6b7280 50%), linear-gradient(135deg, #6b7280 50%, transparent 50%); background-position: calc(100% - 12px) calc(1em + 2px), calc(100% - 7px) calc(1em + 2px); background-size: 6px 6px, 6px 6px; background-repeat: no-repeat; }

        /* Ensure injected service-item rows are normal weight (avoid inline style best-effort) */
        .service-item-row { font-weight: 400; }
        
        /* Sidebar improvements */
        .sidebar-nav-btn {
            transition: all 0.2s;
            position: relative;
        }
        
        .sidebar-nav-btn:hover {
            transform: translateX(4px);
        }
        
        .sidebar-nav-btn.active::before {
            content: '';
            position: absolute;
            left: -12px;
            top: 50%;
            transform: translateY(-50%);
            width: 4px;
            height: 24px;
            background-color: #3b82f6;
            border-radius: 2px;
        }
        
        /* Receipt Styles */
        .receipt {
            width: 80mm;
            max-width: 300px;
            margin: 0 auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.4;
            color: #000;
            background: white;
            padding: 10mm;
        }
        
        .receipt-header {
            text-align: center;
            border-bottom: 1px dashed #000;
            padding-bottom: 10px;
            margin-bottom: 10px;
        }
        
        .receipt-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .receipt-info {
            margin-bottom: 10px;
        }
        
        .receipt-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 3px;
        }
        
        .receipt-separator {
            border-top: 1px dashed #000;
            margin: 10px 0;
        }
        
        .receipt-total {
            font-weight: bold;
            font-size: 14px;
        }
        
        .receipt-footer {
            text-align: center;
            margin-top: 15px;
            font-size: 10px;
        }

        /* Minimal sidebar spacing and colors */
        #sidebarMenu {
            width: 220px;
            min-width: 220px;
            max-width: 220px;
        }

        /* subtle active indicator and hover style */
        .sidebar-nav-btn {
            color: #475569; /* slate-600 */
        }

        .sidebar-nav-btn:hover {
            background: rgba(59,130,246,0.06); /* faint blue */
            color: #1e293b;
            transform: none;
        }
        
        @media print {
            body * {
                visibility: hidden;
            }
            
            .receipt, .receipt * {
                visibility: visible;
            }
            
            .receipt {
                position: absolute;
                left: 0;
                top: 0;
                width: 80mm;
                margin: 0;
                padding: 5mm;
            }
            
            .no-print {
                display: none !important;
            }
        }
       
@media (max-width: 768px) {
    #sidebarMenu {
        width: 64px !important;
        min-width: 64px !important;
        max-width: 64px !important;
        background: white;
        transform: translateX(0);
        transition: transform 0.3s;
        box-shadow: 2px 0 10px rgba(0,0,0,0.1);
    }
    #sidebarMenu.active {
        width: 80vw !important;
        min-width: 200px !important;
        max-width: 320px !important;
        transform: translateX(0);
    }
    /* sidebar overlay: explicit hide/show to avoid accidental blocking of table buttons */
    #sidebarOverlay.hidden { display: none !important; }
    #sidebarOverlay { display: none; }
    #sidebarOverlay.active { display: block; }
    #sidebarMenu .sidebar-nav {
        display: none !important;
    }
    #sidebarMenu.active .sidebar-nav {
        display: block !important;
    }
    #sidebarMenu .hidden.md\:inline {
        display: none !important;
    }
    #sidebarMenu .sidebar-nav-btn {
        justify-content: center;
        padding-left: 0 !important;
        padding-right: 0 !important;
    }
}
@media (max-width: 768px) {
    .main-content {
        margin-left: 64px !important;
        transition: margin-left 0.3s;
    }
    #sidebarMenu.active ~ .main-content {
        margin-left: 80vw !important;
    }
}
    </style>
</head>
<body class="bg-gradient-to-br from-slate-50 to-blue-50 text-gray-800 min-h-screen">

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay hidden">
        <div class="loading-spinner">
            <div class="spinner"></div>
            <div class="text-gray-700 font-medium">Memuat data...</div>
        </div>
    </div>

    <!-- Success Message -->
    <div id="successMessage" class="fixed top-20 right-4 bg-green-500 text-white px-6 py-4 rounded-xl shadow-lg hidden z-50 transform transition-all duration-300">
        <div class="flex items-center gap-3">
            <span class="text-lg">✅</span>
            <span id="successText" class="font-medium">Berhasil</span>
            <button onclick="hideSuccessMessage()" class="ml-2 text-white hover:text-gray-200 text-xl">×</button>
        </div>
    </div>

    <!-- Error Message -->
    <div id="errorMessage" class="fixed top-20 right-4 bg-red-500 text-white px-6 py-4 rounded-xl shadow-lg hidden z-50 transform transition-all duration-300">
        <div class="flex items-center gap-3">
            <span class="text-lg">❌</span>
            <span id="errorText" class="font-medium">Error</span>
            <button onclick="hideErrorMessage()" class="ml-2 text-white hover:text-gray-200 text-xl">×</button>
        </div>
    </div>

    <div class="flex min-h-screen">
   

<!-- Sidebar -->
<div id="sidebarMenu" class="w-16 md:w-64 bg-white border-r border-gray-200 shadow-lg fixed inset-y-0 left-0 z-40 transform -translate-x-full transition-transform duration-300 md:static md:translate-x-0">
    <div class="p-6 border-b border-gray-200 flex flex-col items-center md:flex-row md:justify-between md:items-center">
        <div class="flex items-center space-x-0 md:space-x-3">
                        <div class="w-12 h-12 flex items-center justify-center">
                                <!-- inline emblem to avoid external image load -->
                                <img src="../img/helpdesk.png" alt="">
                        </div>
            <!-- Judul hanya tampil di layar besar -->
            <div class="hidden md:block ml-3">
                <h1 class="text-lg font-bold text-gray-900">Service HP</h1>
                <p class="text-xs text-gray-500">Management System</p>
            </div>
            
        </div>
        <!-- Tombol hamburger selalu tampil di layar kecil -->
        <button onclick="toggleSidebar()" class="md:hidden mt-4 p-2 rounded-lg bg-blue-500 text-white">
            <span class="text-xl">☰</span>
        </button>
    </div>
    <!-- NAVIGATION MENU -->
    <nav class="mt-6 sidebar-nav">
    <div class="px-4 space-y-2">
        <button onclick="showSection('dashboard')" title="Dashboard" aria-label="Dashboard" class="sidebar-nav-btn w-full flex items-center px-4 py-3 text-sm font-medium rounded-xl text-blue-600" id="nav-dashboard">
            <span class="mr-3 text-lg">📊</span>
            <span class="nav-label hidden md:inline">Dashboard</span>
        </button>
        <button onclick="showSection('service')" class="sidebar-nav-btn w-full flex items-center px-4 py-3 text-sm font-medium rounded-xl text-gray-600 hover:text-gray-900 hover:bg-gray-100" id="nav-service">
            <span class="mr-3 text-lg">🔧</span>
            <span class="nav-label hidden md:inline">Data Service</span>
        </button>
        <button onclick="showSection('piutang')" class="sidebar-nav-btn w-full flex items-center px-4 py-3 text-sm font-medium rounded-xl text-gray-600 hover:text-gray-900 hover:bg-gray-100" id="nav-piutang">
            <span class="mr-3 text-lg">💳</span>
            <span class="nav-label hidden md:inline">Data Piutang</span>
        </button>
        <button onclick="showSection('stocks')" class="sidebar-nav-btn w-full flex items-center px-4 py-3 text-sm font-medium rounded-xl text-gray-600 hover:text-gray-900 hover:bg-gray-100" id="nav-stocks">
            <span class="mr-3 text-lg">📦</span>
            <span class="nav-label hidden md:inline">Stok Barang</span>
        </button>
        <button onclick="showSection('serviceTypes')" class="sidebar-nav-btn w-full flex items-center px-4 py-3 text-sm font-medium rounded-xl text-gray-600 hover:text-gray-900 hover:bg-gray-100" id="nav-serviceTypes">
            <span class="mr-3 text-lg">⚙️</span>
            <span class="nav-label hidden md:inline">Jenis Service</span>
        </button>
        <button onclick="showSection('pengeluaran')" class="sidebar-nav-btn w-full flex items-center px-4 py-3 text-sm font-medium rounded-xl text-gray-600 hover:text-gray-900 hover:bg-gray-100" id="nav-pengeluaran">
            <span class="mr-3 text-lg">💸</span>
            <span class="nav-label hidden md:inline">Pengeluaran</span>
        </button>
        <button onclick="showSection('members')" class="sidebar-nav-btn w-full flex items-center px-4 py-3 text-sm font-medium rounded-xl text-gray-600 hover:text-gray-900 hover:bg-gray-100" id="nav-members">
            <span class="mr-3 text-lg">👥</span>
            <span class="nav-label hidden md:inline">Data Member</span>
        </button>
        <button onclick="showSection('laporan')" class="sidebar-nav-btn w-full flex items-center px-4 py-3 text-sm font-medium rounded-xl text-gray-600 hover:text-gray-900 hover:bg-gray-100" id="nav-laporan">
            <span class="mr-3 text-lg">📈</span>
            <span class="nav-label hidden md:inline">Laporan</span>
        </button>
        <button onclick="showSection('users')" class="sidebar-nav-btn w-full flex items-center px-4 py-3 text-sm font-medium rounded-xl text-gray-600 hover:text-gray-900 hover:bg-gray-100" id="nav-users">
            <span class="mr-3 text-lg">👤</span>
            <span class="nav-label hidden md:inline">Data Users</span>
        </button>
    </div>
        </nav>
<!-- Sidebar User Info -->



</div>


<!-- Overlay untuk sidebar -->
<div id="sidebarOverlay" class="fixed inset-0 bg-black bg-opacity-40 z-30 hidden md:hidden"></div>
        <!-- Main Content -->
        <div class="main-content flex-1 overflow-hidden">
            <!-- Top header aligned with sidebar -->
            <header id="topHeader" class="hidden md:flex items-center justify-between bg-white border-b border-gray-200 px-6 py-4 shadow-sm">
                <div class="flex items-center gap-4">
                    <h2 id="topHeaderTitle" class="text-lg font-semibold text-gray-900">Dashboard</h2>
                    <p id="topHeaderSubtitle" class="text-sm text-gray-500 hidden">Ringkasan aktivitas</p>
                </div>
                <div class="flex items-center gap-3">
                    <div id="headerAvatarContainer" role="button" tabindex="0" aria-haspopup="true" aria-expanded="false" class="cursor-pointer w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center text-white text-sm font-semibold overflow-hidden">
                    <img id="headerAvatarImg" src="" alt="avatar" class="w-full h-full object-cover hidden">
                    <span id="headerAvatarInitial">A</span>
                </div>
                    <div id="topHeaderActions" class="flex items-center gap-2">
                        <!-- dropdown trigger and menu -->
                        <div class="relative">
                            <button id="headerAvatarBtn" class="focus:outline-none" onclick="(function(e){e.stopPropagation(); toggleHeaderDropdown();})(event)" aria-haspopup="true" aria-expanded="false">
                                <!-- avatar already displayed to the left; this button is invisible but clickable to open menu -->
                                <span class="sr-only">Open user menu</span>
                            </button>
                            <div id="headerDropdown" class="absolute right-0 mt-2 w-48 bg-white rounded-xl shadow-lg border border-gray-100 py-2 z-50 hidden">
                                <div class="px-4 py-2">
                                    <div id="headerDropdownName" class="font-semibold text-gray-800">Nama User</div>
                                    <div id="headerDropdownRole" class="text-xs text-gray-500">Jabatan</div>
                                </div>
                                <div class="border-t border-gray-100 mt-2"></div>
                                <button onclick="logout()" class="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50">Logout</button>
                            </div>
                        </div>
                    </div>
                </div>
            </header>

            <script>
                // Header dropdown controls: toggle, prevent close when interacting inside,
                // close when clicking outside, and close on Escape key.
                function toggleHeaderDropdown() {
                    const menu = document.getElementById('headerDropdown');
                    const btn = document.getElementById('headerAvatarBtn') || document.getElementById('headerAvatarContainer');
                    if (!menu) return;
                    // toggle Tailwind 'hidden' class
                    const isHidden = menu.classList.contains('hidden');
                    if (isHidden) {
                        menu.classList.remove('hidden');
                        // ensure visible even if Tailwind classes conflict
                        menu.style.display = 'block';
                    } else {
                        menu.classList.add('hidden');
                        menu.style.display = 'none';
                    }
                    const expanded = !menu.classList.contains('hidden');
                    if (btn) btn.setAttribute('aria-expanded', expanded ? 'true' : 'false');
                    // If opening, focus first interactive element for accessibility
                    if (expanded) {
                        const firstFocusable = menu.querySelector('button, a, [tabindex]:not([tabindex="-1"])');
                        if (firstFocusable) firstFocusable.focus();
                    }
                }

                document.addEventListener('DOMContentLoaded', function () {
                    const menu = document.getElementById('headerDropdown');
                    const container = document.getElementById('headerAvatarContainer');
                    if (menu) {
                        // prevent clicks inside the menu from bubbling and closing it
                        menu.addEventListener('click', function (e) { e.stopPropagation(); });
                    }

                    // Attach programmatic handlers to the avatar container to avoid ordering/conflict
                    if (container) {
                        // stop propagation so document click doesn't immediately close it
                        container.addEventListener('click', function (e) { e.stopPropagation(); toggleHeaderDropdown(); });
                        container.addEventListener('keydown', function (e) { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); e.stopPropagation(); toggleHeaderDropdown(); } });
                    }

                    // Close dropdown when clicking outside
                    document.addEventListener('click', function (e) {
                        const menu = document.getElementById('headerDropdown');
                        if (!menu) return;
                        if (menu.classList.contains('hidden')) return; // closed already
                        if ((container && container.contains(e.target)) || menu.contains(e.target)) return;
                        menu.classList.add('hidden');
                        const btn = document.getElementById('headerAvatarBtn') || container;
                        if (btn) btn.setAttribute('aria-expanded', 'false');
                    });

                    // Close on Escape key
                    document.addEventListener('keydown', function (e) {
                        if (e.key === 'Escape' || e.key === 'Esc') {
                            const menu = document.getElementById('headerDropdown');
                            if (!menu) return;
                            if (!menu.classList.contains('hidden')) {
                                menu.classList.add('hidden');
                                const btn = document.getElementById('headerAvatarBtn') || container;
                                if (btn) btn.setAttribute('aria-expanded', 'false');
                            }
                        }
                    });
                });
            </script>

            <!-- Dashboard Section -->
            <div id="dashboard" class="section active p-8">
                
                <!-- Stats Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="card p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-600">Pemasukan Hari Ini</p>
                                <p class="text-2xl font-bold text-green-600 mt-1" id="todayIncome">Rp 0</p>
                            </div>
                            <div class="w-12 h-12 bg-gradient-to-br from-green-100 to-green-200 rounded-xl flex items-center justify-center">
                                <span class="text-green-600 text-xl">💰</span>
                            </div>
                        </div>
                    </div>

                    <div class="card p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-600">Pengeluaran Hari Ini</p>
                                <p class="text-2xl font-bold text-red-600 mt-1" id="todayExpense">Rp 0</p>
                            </div>
                            <div class="w-12 h-12 bg-gradient-to-br from-red-100 to-red-200 rounded-xl flex items-center justify-center">
                                <span class="text-red-600 text-xl">💸</span>
                            </div>
                        </div>
                    </div>

                    <div class="card p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-600">Service Hari Ini</p>
                                <p class="text-2xl font-bold text-blue-600 mt-1" id="todayServices">0</p>
                            </div>
                            <div class="w-12 h-12 bg-gradient-to-br from-blue-100 to-blue-200 rounded-xl flex items-center justify-center">
                                <span class="text-blue-600 text-xl">🔧</span>
                            </div>
                        </div>
                    </div>

                    <div class="card p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-600">Total Piutang</p>
                                <p class="text-2xl font-bold text-orange-600 mt-1" id="totalPiutang">Rp 0</p>
                            </div>
                            <div class="w-12 h-12 bg-gradient-to-br from-orange-100 to-orange-200 rounded-xl flex items-center justify-center">
                                <span class="text-orange-600 text-xl">💳</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Chart Revenue Bulanan dan Service Terpopuler di Dashboard -->
                <div id="dashboardCharts" class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                    <div class="bg-white rounded-xl shadow p-6">
                        <h3 class="text-lg font-semibold mb-4">Revenue Bulanan</h3>
                        <canvas id="monthlyRevenueChart" height="220"></canvas>
                    </div>
                    <div class="bg-white rounded-xl shadow p-6">
                        <h3 class="text-lg font-semibold mb-4">Service Terpopuler</h3>
                        <canvas id="popularServiceChart" height="220"></canvas>
                    </div>
                </div>

                <!-- Stock Chart -->
                <div class="card p-6">
                    <h3 class="text-xl font-semibold text-gray-900 mb-4">Stok Barang (Grafik)</h3>
                    <div class="w-full">
                        <canvas id="stocksChart" height="120"></canvas>
                    </div>
                    <div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="p-4 bg-gray-50 rounded-xl text-center">
                            <div class="text-sm text-gray-500">Jumlah SKU</div>
                            <div id="stocksTotalSkus" class="text-2xl font-bold">0</div>
                        </div>
                        <div class="p-4 bg-gray-50 rounded-xl text-center">
                            <div class="text-sm text-gray-500">Total Kuantitas</div>
                            <div id="stocksTotalQty" class="text-2xl font-bold">0</div>
                        </div>
                        <div class="p-4 bg-gray-50 rounded-xl text-center">
                            <div class="text-sm text-gray-500">Total Nilai</div>
                            <div id="stocksTotalValue" class="text-2xl font-bold">Rp 0</div>
                        </div>
                    </div>
                    <div class="mt-4">
                        <div class="flex items-center gap-3">
                            <button id="stocksDetailToggle" onclick="toggleStocksDetails()" class="px-4 py-2 bg-white border rounded-lg">Lihat Detail</button>
                        </div>
                        <div id="stocksDetailContainer" class="mt-4 hidden">
                            <div class="table-scroll-container">
                                <table id="stocksDetailTable" class="w-full text-sm">
                                    <thead>
                                        <tr>
                                            <th class="text-left p-2" style="width:15%">SKU</th>
                                            <th class="text-left p-2" style="width:20%">Barcode</th>
                                            <th class="text-left p-2" style="width:30%">Nama</th>
                                            <th class="text-right p-2" style="width:10%">Qty</th>
                                            <th class="text-right p-2" style="width:12%">Harga</th>
                                            <th class="text-right p-2" style="width:13%">Nilai</th>
                                        </tr>
                                    </thead>
                                    <tbody id="stocksDetailTbody">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Service Section -->
            <div id="service" class="section p-8">
                
                

                <div class="table-container">
                    <div class="table-header">
                        <div class="flex items-center justify-between">
                            <div>
                                <h3 class="text-xl font-semibold text-gray-900">Daftar Service</h3>
                                <p>Data Service Pelanggan</p>
                            </div>
                            <div class="flex flex-wrap items-center gap-2 mb-4">
                            <input type="text" id="strukNamaPelanggan" placeholder="Nama Pelanggan" class="px-2 py-2 border border-gray-100 rounded-lg text-sm w-auto min-w-0">
                            <input type="date" id="strukStartDate" class="px-2 py-2 border border-gray-100 rounded-lg text-sm w-auto min-w-0">
                            <input type="date" id="strukEndDate" class="px-2 py-2 border border-gray-100 rounded-lg text-sm w-auto min-w-0">
                            <button onclick="printStrukByNamaDanTanggal()" class="px-3 py-2 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-lg text-sm flex items-center gap-2 w-auto min-w-0">
                            🖨️ 
                            </button>
                            <button onclick="showAddServiceModal()" class="px-3 py-2 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-lg text-sm flex items-center gap-2 w-auto min-w-0">
                             ➕ 
                            </button>
                        </div>
                    </div>
            </div>
                    <div class="p-6">
                        <div class="table-scroll-container">
                            <table id="serviceTable" class="w-full">
                                <thead>
                                    <tr>
                                        <th>Tanggal</th>
                                        <th>Pelanggan</th>
                                        <th>Service</th>
                                        <th>Jenis Service</th>
                                        <th>No. HP</th>
                                        <th>Harga</th>
                                        <th>Status</th>
                                        <th>Aksi</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Data will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Piutang Section -->
            <div id="piutang" class="section p-8">
                <!-- <div class="flex justify-between items-center mb-8">
                    <div>
                        <h2 class="text-3xl font-bold text-gray-900">Data Piutang</h2>
                        <p class="text-gray-600 mt-2">Kelola status pembayaran service</p>
                    </div>
                </div> -->

                <div class="table-container">
                    <div class="table-header">
                        <div class="flex items-center justify-between">
                            <div>
                                <h3 class="text-xl font-semibold text-gray-900">Daftar Piutang</h3>
                                <p class="text-sm text-gray-600 mt-1">Data pembayaran yang tertunda</p>
                            </div>
                            <div class="flex flex-wrap items-center gap-2 mb-4">
                            <select id="piutangFilter" onchange="filterPiutang()" class="px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white shadow-sm">
                        <option value="all">Semua Status</option>
                        <option value="belum">Belum Bayar</option>
                        <option value="sudah">Sudah Bayar</option>
                    </select>
                            </div>
                        </div>
                    </div>
                    <div class="p-6">
                        <div class="table-scroll-container">
                            <table id="piutangTable" class="w-full">
                                <thead>
                                    <tr>
                                        <th>Tanggal</th>
                                        <th>Pelanggan</th>
                                        <th>Service</th>
                                        <th>Jenis Service</th>
                                        <th>Jumlah</th>
                                        <th>Hari Terlambat</th>
                                        <th>Aksi</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Data will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pengeluaran Section -->
            <div id="pengeluaran" class="section p-8">
                <!-- <div class="flex justify-between items-center mb-8">
                    <div>
                        <h2 class="text-3xl font-bold text-gray-900">Pengeluaran</h2>
                        <p class="text-gray-600 mt-2">Kelola data pengeluaran operasional</p>
                    </div>
                </div> -->

                <div class="table-container">
                    <div class="table-header">
                        <div class="flex items-center justify-between">
                            <div>
                                <h3 class="text-xl font-semibold text-gray-900">Daftar Pengeluaran</h3>
                                <p>Data pengeluaran operasional</p>
                            </div>
                            <div class="flex flex-wrap items-center gap-2 mb-4">
                            <button onclick="showAddExpenseModal()" class="px-3 py-2 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-lg text-sm flex items-center gap-2 w-auto min-w-0">
                             Tambah Pengeluaran
                            </button>
                            </div>
                        </div>
                    </div>
                    <div class="p-6">
                        <div class="table-scroll-container">
                            <table id="expenseTable" class="w-full">
                                <thead>
                                    <tr>
                                        <th>Tanggal</th>
                                        <th>Kategori</th>
                                        <th>Deskripsi</th>
                                        <th>Jumlah</th>
                                        <th>Aksi</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Data will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Laporan Section -->
            <div id="laporan" class="section p-8">
                <div class="flex justify-between items-center mb-8">
                    <div>
                        <h2 class="text-3xl font-bold text-gray-900">Laporan</h2>
                        <p class="text-gray-600 mt-2">Laporan keuangan dan analisis bisnis</p>
                    </div>
                    <div class="flex gap-3">
                        <input type="date" id="reportStartDate" class="px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white shadow-sm">
                        <input type="date" id="reportEndDate" class="px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white shadow-sm">
                        <button onclick="filterReportByDate()" class="px-6 py-3 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-xl hover:from-blue-600 hover:to-blue-700 font-medium shadow-lg transition-all duration-200 transform hover:scale-105">
                            📊 Filter
                        </button>
                        <button onclick="downloadReport()" class="px-6 py-3 bg-gradient-to-r from-green-500 to-green-600 text-white rounded-xl hover:from-green-600 hover:to-green-700 font-medium shadow-lg transition-all duration-200 transform hover:scale-105">
                            📥 Download
                        </button>
                    </div>
                </div>

                <!-- Summary Report -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="card p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-600">Total Pemasukan</p>
                                <p class="text-base font-bold text-green-600 mt-1" id="reportIncome">Rp 0</p>
                            </div>
                            <div class="w-12 h-12 bg-gradient-to-br from-green-100 to-green-200 rounded-xl flex items-center justify-center">
                                <span class="text-green-600 text-xl">💰</span>
                            </div>
                        </div>
                    </div>

                    <div class="card p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-600">Total Pengeluaran</p>
                                <p class="text-base font-bold text-red-600 mt-1" id="reportExpense">Rp 0</p>
                            </div>
                            <div class="w-12 h-12 bg-gradient-to-br from-red-100 to-red-200 rounded-xl flex items-center justify-center">
                                <span class="text-red-600 text-xl">💸</span>
                            </div>
                        </div>
                    </div>

                    <div class="card p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-600">Laba/Rugi</p>
                                <p class="text-base font-bold text-gray-600 mt-1" id="reportProfit">Rp 0</p>
                            </div>
                            <div class="w-12 h-12 bg-gradient-to-br from-gray-100 to-gray-200 rounded-xl flex items-center justify-center">
                                <span class="text-gray-600 text-xl">📊</span>
                            </div>
                        </div>
                    </div>

                    <div class="card p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-600">Total Service</p>
                                <p class="text-2xl font-bold text-blue-600 mt-1" id="reportServices">0</p>
                            </div>
                            <div class="w-12 h-12 bg-gradient-to-br from-blue-100 to-blue-200 rounded-xl flex items-center justify-center">
                                <span class="text-blue-600 text-xl">🔧</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Detailed Report -->
                <div class="card mb-8">
                    <div class="table-header">
                        <h3 class="text-xl font-semibold text-gray-900">Detail Laporan Keuangan</h3>
                        <p class="text-sm text-gray-600 mt-1">Rincian pemasukan dan pengeluaran periode <span id="reportPeriod">semua waktu</span></p>
                    </div>
                    <div class="p-6">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <!-- Income Details -->
                            <div>
                                <h4 class="text-lg font-semibold text-green-600 mb-4 flex items-center gap-2">
                                    <span>📈</span>
                                    Rincian Pemasukan
                                </h4>
                                <div class="space-y-3" id="incomeDetails">
                                    <!-- Income details will be populated here -->
                                </div>
                            </div>
                            
                            <!-- Expense Details -->
                            <div>
                                <h4 class="text-lg font-semibold text-red-600 mb-4 flex items-center gap-2">
                                    <span>📉</span>
                                    Rincian Pengeluaran
                                </h4>
                                <div class="space-y-3" id="expenseDetails">
                                    <!-- Expense details will be populated here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Charts -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="card p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Pemasukan vs Pengeluaran</h3>
                        <div style="position: relative; height: 300px;">
                            <canvas id="incomeExpenseChart"></canvas>
                        </div>
                    </div>

                    <div class="card p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Service Terpopuler</h3>
                        <div style="position: relative; height: 300px;">
                            <canvas id="serviceTypeChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Service Types Section -->
            <div id="serviceTypes" class="section p-8">
                <!-- <div class="flex justify-between items-center mb-8">
                </div> -->

                <div class="table-container">
                    <div class="table-header">
                        <div class="flex items-center justify-between">
                            <div>
                                <h3 class="text-xl font-semibold text-gray-900">Master Jenis Service</h3>
                                <p class="text-sm text-gray-600 mt-1">Daftar layanan yang tersedia</p>
                            </div>
                            <div class="flex flex-wrap items-center gap-2 mb-4">
                            <button onclick="showAddServiceTypeModal()" class="px-3 py-2 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-lg text-sm flex items-center gap-2 w-auto min-w-0">
                             Tambah Jenis Service
                            </button>
                            </div>
                        </div>
                    </div>
                    <div class="p-6">
                        <div class="table-scroll-container">
                            <table id="serviceTypesTable" class="w-full">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Nama Service</th>
                                        <th>Deskripsi</th>
                                        <th>Status</th>
                                        <th>Aksi</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Data will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Members Section -->
            <div id="members" class="section p-8">
                <!-- <div class="flex justify-between items-center mb-8">
                    <div>
                        <h2 class="text-3xl font-bold text-gray-900">Data Member</h2>
                        <p class="text-gray-600 mt-2">Kelola data member dan program loyalitas</p>
                    </div>
                   
                </div> -->

                <div class="table-container">
                    <div class="table-header">
                        <div class="flex items-center justify-between">
                            <div>
                                <h3 class="text-xl font-semibold text-gray-900">Database Member</h3>
                                <p class="text-sm text-gray-600 mt-1">Data member dan riwayat transaksi</p>
                            </div>
                            <div class="flex flex-wrap items-center gap-2 mb-4">
                            <button onclick="showAddMemberModal()" class="px-3 py-2 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-lg text-sm flex items-center gap-2 w-auto min-w-0">
                             Tambah Member
                            </button>
                            </div>
                        </div>
                    </div>
                    <div class="p-6">
                        <div class="table-scroll-container">
                            <table id="membersTable" class="w-full">
                                <thead>
                                    <tr>
                                        <th>Kode Member</th>
                                        <th>Nama Lengkap</th>
                                        <th>Kontak</th>
                                        <th>Bergabung</th>
                                        <th>Total Service</th>
                                        <th>Total Belanja</th>
                                        <th>Status</th>
                                        <th>Aksi</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Data will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Users Section -->
<div id="users" class="section p-8">
    <!-- <div class="flex justify-between items-center mb-8"> -->
    <script>
    function showAddUserModal() {
        const modal = document.getElementById('addUserModal');
        if (modal) {
            // populate photo select from server (if photo select exists)
            const photoSelect = document.getElementById('userPhoto');
            const photoPreview = document.getElementById('userPhotoPreview');
            if (photoSelect) {
                photoSelect.innerHTML = '<option value="">-- Tidak Ada --</option>';
                fetch('/api/images', { credentials: 'same-origin' })
                    .then(r => r.json())
                    .then(result => {
                        if (result && result.success && Array.isArray(result.data)) {
                            result.data.forEach(fn => {
                                const opt = document.createElement('option');
                                opt.value = fn;
                                opt.textContent = fn;
                                photoSelect.appendChild(opt);
                            });
                        }
                    }).catch(() => {});
                if (photoPreview) { photoPreview.classList.add('hidden'); photoPreview.src = ''; }
            }

            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }
    }
    </script>
    <!-- </div> -->

    <div class="table-container">
        <div class="table-header">
            <div class="flex items-center justify-between">
                <div>
                    <h3 class="text-xl font-semibold text-gray-900">Database User</h3>
                    <p class="text-sm text-gray-600 mt-1">Daftar user aplikasi dan hak akses</p>
                </div>
                <div class="flex flex-wrap items-center gap-2 mb-4">
                            <button onclick="showAddUserModal()" class="px-3 py-2 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-lg text-sm flex items-center gap-2 w-auto min-w-0">
                             Tambah User
                            </button>
                            </div>
            </div>
        </div>
        <div class="p-6">
            <div class="table-scroll-container">
                <table id="usersTable" class="w-full">
                    <thead>
                                <tr>
                                    <th>Foto</th>
                                    <th>Nama Lengkap</th>
                                    <th>Username</th>
                                    <th>Email</th>
                                    <th>Role</th>
                                    <th>Status</th>
                                    <th>Last Login</th>
                                    <th>Aksi</th>
                                </tr>
                    </thead>
                    <tbody>
                        <!-- Data will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

            <!-- Stocks Section -->
            <div id="stocks" class="section p-8">
                

                <div class="table-container">
                    <div class="table-header">
                        <div class="flex items-center justify-between w-full">
                            <div class="flex items-center gap-3">
                            <div>
                                <h3 class="text-xl font-semibold text-gray-900">Database Stok Barang</h3>
                                <p class="text-sm text-gray-600 mt-1">Data Stok Barang dan riwayat Stok Barang</p>
                            </div>
                            </div>
                            <div class="flex items-center gap-3">
                                <button onclick="showAddStockModal()" class="px-4 py-2 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-xl shadow hover:from-blue-600">Tambah Stok</button>
                            </div>
                        </div>
                    </div>
                    <div class="p-6">
                        <div class="table-scroll-container">
                            <table id="stocksTable" class="w-full">
                                <thead>
                                    <tr>
                                        <th>SKU</th>
                                            <th>Barcode</th>
                                        <th>Nama Barang</th>
                                        <th>Kategori</th>
                                        <th>Stok</th>
                                        <th>Harga</th>
                                        <th>Aksi</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- data injected by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal untuk Tambah Service (redesigned minimal) -->
    <div id="addServiceModal" class="fixed inset-0 bg-black bg-opacity-40 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl w-full max-w-lg max-h-[90vh] overflow-y-auto shadow-xl border border-gray-100">
            <div class="p-4 flex items-center justify-between border-b border-gray-100">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-lg flex items-center justify-center text-white text-lg">🔧</div>
                    <div>
                        <div class="text-lg font-semibold">Tambah Service</div>
                        <div class="text-xs text-gray-500">Masukkan layanan atau sparepart</div>
                    </div>
                </div>
                <button onclick="closeModal('addServiceModal')" aria-label="Tutup" class="text-gray-400 hover:text-gray-700">✕</button>
            </div>

            <form onsubmit="addService(event)" class="p-4 space-y-4">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                    <div>
                        <label class="text-xs font-medium text-gray-600">Tanggal</label>
                        <input type="date" id="serviceDate" class="mt-1 block w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm" required>
                    </div>
                    <div>
                        <label class="text-xs font-medium text-gray-600">No. HP</label>
                        <input type="tel" id="customerPhone" placeholder="0812xxxxxxx" class="mt-1 block w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm" required>
                    </div>
                    <div class="sm:col-span-2">
                        <label class="text-xs font-medium text-gray-600">Nama Pelanggan</label>
                        <input type="text" id="customerName" placeholder="Nama lengkap" class="mt-1 block w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm" required>
                    </div>
                </div>

                <div>
                    <label class="text-xs font-medium text-gray-600">Service / Sparepart</label>
                    <div class="mt-2 flex items-center gap-2 text-sm text-gray-600">
                        <label class="inline-flex items-center gap-2"><input type="radio" name="serviceSource" value="type" id="serviceSourceType" checked class="form-radio" />Service</label>
                        <label class="inline-flex items-center gap-2"><input type="radio" name="serviceSource" value="stock" id="serviceSourceStock" class="form-radio" />Sparepart</label>
                        <button type="button" onclick="addServiceItemRow()" class="ml-auto px-3 py-1 bg-blue-50 text-blue-700 rounded-lg text-sm">+ Tambah</button>
                    </div>

                    <div id="serviceItemsContainer" class="mt-3 space-y-2">
                        <!-- JS injects item rows here; keep IDs intact -->
                    </div>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                    <div>
                        <label class="text-xs font-medium text-gray-600">Total Harga</label>
                        <input type="number" id="servicePrice" placeholder="0" class="mt-1 block w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm" required>
                    </div>
                    <div>
                        <label class="text-xs font-medium text-gray-600">Status Bayar</label>
                        <select id="paymentStatus" class="mt-1 block w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm" required>
                            <option value="Sudah Bayar">Sudah Bayar</option>
                            <option value="Belum Bayar">Belum Bayar</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label class="text-xs font-medium text-gray-600">Keterangan (opsional)</label>
                    <textarea id="serviceNotes" rows="2" class="mt-1 block w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm resize-none" placeholder="Catatan tambahan"></textarea>
                </div>

                <div class="flex items-center gap-3 mt-2">
                        <!-- 'Hapus Semua' button removed per request -->
                    <div class="flex-1"></div>
                    <button type="button" onclick="closeModal('addServiceModal')" class="px-4 py-2 border border-gray-200 rounded-lg text-sm">Batal</button>
                    <button type="submit" class="px-4 py-2 bg-gradient-to-r from-blue-500 to-indigo-600 text-white rounded-lg text-sm">Simpan</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal untuk Tambah Pengeluaran -->
    <div id="addExpenseModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl w-full max-w-md max-h-[90vh] overflow-y-auto shadow-2xl">
            <div class="p-6 border-b border-gray-200">
                <h3 class="text-xl font-semibold text-gray-900">Tambah Pengeluaran</h3>
            </div>
            <form onsubmit="addExpense(event)" class="p-6">
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Tanggal</label>
                            <input type="date" id="expenseDate" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-red-500 focus:border-red-500" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Jumlah</label>
                            <input type="number" id="expenseAmount" placeholder="0" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-red-500 focus:border-red-500" required>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Kategori</label>
                        <select id="expenseCategory" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-red-500 focus:border-red-500" required>
                            <option value="">Pilih Kategori</option>
                            <option value="Spare Parts">Spare Parts</option>
                            <option value="Tools & Equipment">Tools & Equipment</option>
                            <option value="Operational">Operational</option>
                            <option value="Marketing">Marketing</option>
                            <option value="Transportation">Transportation</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Deskripsi</label>
                        <input type="text" id="expenseDescription" placeholder="Deskripsi pengeluaran" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-red-500 focus:border-red-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Catatan</label>
                        <textarea id="expenseNotes" placeholder="Catatan tambahan (opsional)" rows="3" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-red-500 focus:border-red-500 resize-none"></textarea>
                    </div>
                </div>
                <div class="flex gap-3 mt-8">
                    <button type="button" onclick="closeModal('addExpenseModal')" class="flex-1 px-6 py-3 border border-gray-200 text-gray-700 rounded-xl hover:bg-gray-50 font-medium transition-all duration-200">
                        Batal
                    </button>
                    <button type="submit" class="flex-1 px-6 py-3 bg-gradient-to-r from-red-500 to-red-600 text-white rounded-xl hover:from-red-600 hover:to-red-700 font-medium shadow-lg transition-all duration-200">
                        Simpan
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal untuk Tambah Jenis Service -->
    <div id="addServiceTypeModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl w-full max-w-md shadow-2xl">
            <div class="p-6 border-b border-gray-200">
                <h3 class="text-xl font-semibold text-gray-900">Tambah Jenis Service</h3>
            </div>
            <form onsubmit="addServiceType(event)" class="p-6">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Nama Service</label>
                        <input type="text" id="serviceTypeName" placeholder="Contoh: Ganti LCD" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-purple-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Deskripsi</label>
                        <textarea id="serviceTypeDescription" placeholder="Deskripsi jenis service" rows="3" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-purple-500 resize-none"></textarea>
                    </div>
                </div>
                <div class="flex gap-3 mt-8">
                    <button type="button" onclick="closeModal('addServiceTypeModal')" class="flex-1 px-6 py-3 border border-gray-200 text-gray-700 rounded-xl hover:bg-gray-50 font-medium transition-all duration-200">
                        Batal
                    </button>
                    <button type="submit" class="flex-1 px-6 py-3 bg-gradient-to-r from-purple-500 to-purple-600 text-white rounded-xl hover:from-purple-600 hover:to-purple-700 font-medium shadow-lg transition-all duration-200">
                        Simpan
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal untuk Tambah Member -->
    <div id="addMemberModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl w-full max-w-md max-h-[90vh] overflow-y-auto shadow-2xl">
            <div class="p-6 border-b border-gray-200">
                <h3 class="text-xl font-semibold text-gray-900">Tambah Member Baru</h3>
            </div>
            <form onsubmit="addMember(event)" class="p-6">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Nama Lengkap</label>
                        <input type="text" id="memberName" placeholder="Nama lengkap member" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">No. HP</label>
                        <input type="tel" id="memberPhone" placeholder="08123456789" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                        <input type="email" id="memberEmail" placeholder="email@example.com (opsional)" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Alamat</label>
                        <textarea id="memberAddress" placeholder="Alamat lengkap (opsional)" rows="3" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 resize-none"></textarea>
                    </div>
                </div>
                <div class="flex gap-3 mt-8">
                    <button type="button" onclick="closeModal('addMemberModal')" class="flex-1 px-6 py-3 border border-gray-200 text-gray-700 rounded-xl hover:bg-gray-50 font-medium transition-all duration-200">
                        Batal
                    </button>
                    <button type="submit" class="flex-1 px-6 py-3 bg-gradient-to-r from-indigo-500 to-indigo-600 text-white rounded-xl hover:from-indigo-600 hover:to-indigo-700 font-medium shadow-lg transition-all duration-200">
                        Simpan
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal untuk Tambah User -->
<div id="addUserModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
    <div class="bg-white rounded-2xl w-full max-w-sm max-h-[90vh] overflow-y-auto shadow-2xl flex flex-col">
        <div class="p-6 border-b border-gray-200">
            <h3 class="text-xl font-semibold text-gray-900">Tambah User Baru</h3>
        </div>
        <form onsubmit="addUser(event)" class="p-6 w-full">
            <div class="grid grid-cols-1 gap-3">
                <div>
                    <label for="userName" class="block text-sm font-medium text-gray-700 mb-1">Nama Lengkap</label>
                    <input type="text" id="userName" name="userName" required class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm">
                </div>
                <div>
                    <label for="userUsername" class="block text-sm font-medium text-gray-700 mb-1">Username</label>
                    <input type="text" id="userUsername" name="userUsername" required class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm">
                </div>
                <div>
                    <label for="userPassword" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                    <input type="password" id="userPassword" name="userPassword" required class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm">
                </div>
                <div>
                    <label for="userEmail" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <input type="email" id="userEmail" name="userEmail" required class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm">
                </div>
                <div>
                    <label for="userRole" class="block text-sm font-medium text-gray-700 mb-1">Role</label>
                    <select id="userRole" name="userRole" required class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm">
                        <option value="admin">Admin</option>
                        <option value="operator">Staff</option>
                    </select>
                </div>
                <div>
                    <label for="userStatus" class="block text-sm font-medium text-gray-700 mb-1">Status Akun</label>
                    <select id="userStatus" name="userStatus" required class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm">
                        <option value="true">Aktif</option>
                        <option value="false">Nonaktif</option>
                    </select>
                </div>
                <div>
                    <label for="userPhoto" class="block text-sm font-medium text-gray-700 mb-1">Foto</label>
                    <div class="flex items-center gap-3">
                        <img id="userPhotoPreview" src="" alt="preview" class="w-12 h-12 rounded-full object-cover hidden">
                        <div class="flex flex-col">
                            <input type="file" id="userPhotoFile" accept="image/*" class="text-sm" />
                            <input type="hidden" id="userPhotoHidden" value="">
                        </div>
                    </div>
                </div>
            </div>
            <div class="flex gap-3 mt-8">
                    <button type="button" onclick="closeModal('addUserModal')" class="flex-1 px-6 py-3 border border-gray-200 text-gray-700 rounded-lg bg-white hover:bg-gray-50 font-medium transition-all duration-200 text-sm">
                        Batal
                    </button>
                    <button type="submit" class="flex-1 px-6 py-3 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-lg font-medium shadow-lg hover:from-blue-600 hover:to-blue-700 transition-all duration-200 text-sm">
                        Tambah
                    </button>
                </div>
        </form>
    </div>
</div>

<!-- Modal untuk Tambah Stok Barang -->
<div id="addStockModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
    <div class="bg-white rounded-2xl w-full max-w-md overflow-y-auto shadow-2xl">
        <div class="p-6 border-b border-gray-200">
            <h3 class="text-xl font-semibold text-gray-900">Tambah Stok Barang</h3>
        </div>
        <form onsubmit="addStock(event)" class="p-6">
            <div class="space-y-4">
                <div>
                    <label class="text-sm">SKU</label>
                    <input id="stockSku" class="w-full px-3 py-2 border rounded mt-1" required>
                </div>
                <div>
                    <label class="text-sm">Barcode</label>
                    <input id="stockBarcode" class="w-full px-3 py-2 border rounded mt-1">
                </div>
                <div>
                    <label class="text-sm">Nama Barang</label>
                    <input id="stockName" class="w-full px-3 py-2 border rounded mt-1" required>
                </div>
                <div>
                    <label class="text-sm">Kategori</label>
                    <input id="stockCategory" class="w-full px-3 py-2 border rounded mt-1">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-sm">Stok</label>
                        <input id="stockQty" type="number" min="0" class="w-full px-3 py-2 border rounded mt-1" required>
                    </div>
                    <div>
                        <label class="text-sm">Harga</label>
                        <input id="stockPrice" type="number" min="0" class="w-full px-3 py-2 border rounded mt-1">
                    </div>
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button type="button" onclick="closeModal('addStockModal')" class="flex-1 px-4 py-2 border rounded">Batal</button>
                <button type="submit" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded">Simpan</button>
            </div>
        </form>
    </div>
</div>

<!-- Modal untuk Edit Stok Barang -->
<div id="editStockModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
    <div class="bg-white rounded-2xl w-full max-w-md overflow-y-auto shadow-2xl">
        <div class="p-6 border-b border-gray-200">
            <h3 class="text-xl font-semibold text-gray-900">Edit Stok Barang</h3>
        </div>
        <form onsubmit="updateStock(event)" class="p-6">
            <input type="hidden" id="editStockId">
            <div class="space-y-4">
                <div>
                    <label class="text-sm">SKU</label>
                    <input id="editStockSku" class="w-full px-3 py-2 border rounded mt-1" required>
                </div>
                <div>
                    <label class="text-sm">Barcode</label>
                    <input id="editStockBarcode" class="w-full px-3 py-2 border rounded mt-1">
                </div>
                <div>
                    <label class="text-sm">Nama Barang</label>
                    <input id="editStockName" class="w-full px-3 py-2 border rounded mt-1" required>
                </div>
                <div>
                    <label class="text-sm">Kategori</label>
                    <input id="editStockCategory" class="w-full px-3 py-2 border rounded mt-1">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-sm">Stok</label>
                        <input id="editStockQty" type="number" min="0" class="w-full px-3 py-2 border rounded mt-1" required>
                    </div>
                    <div>
                        <label class="text-sm">Harga</label>
                        <input id="editStockPrice" type="number" min="0" class="w-full px-3 py-2 border rounded mt-1">
                    </div>
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button type="button" onclick="closeModal('editStockModal')" class="flex-1 px-4 py-2 border rounded">Batal</button>
                <button type="submit" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded">Update</button>
            </div>
        </form>
    </div>
</div>

<!-- Modal untuk Edit User -->
<div id="editUserModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
    <div class="bg-white rounded-2xl w-full max-w-md max-h-[90vh] overflow-y-auto shadow-2xl">
        <div class="p-6 border-b border-gray-200">
            <h3 class="text-xl font-semibold text-gray-900">Edit User</h3>
        </div>
        <form onsubmit="updateUser(event)" class="p-6">
            <input type="hidden" id="editUserId">
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nama Lengkap</label>
                    <input type="text" id="editUserName" class="w-full px-4 py-3 border border-gray-200 rounded-xl" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                    <input type="text" id="editUserUsername" class="w-full px-4 py-3 border border-gray-200 rounded-xl" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                    <input type="email" id="editUserEmail" class="w-full px-4 py-3 border border-gray-200 rounded-xl">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Role</label>
                    <select id="editUserRole" class="w-full px-4 py-3 border border-gray-200 rounded-xl" required>
                        <option value="admin">Admin</option>
                        <option value="staff">Staff</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                    <select id="editUserStatus" class="w-full px-4 py-3 border border-gray-200 rounded-xl" required>
                        <option value="true">Aktif</option>
                        <option value="false">Nonaktif</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Password Baru (opsional)</label>
                    <input type="password" id="editUserPassword" class="w-full px-4 py-3 border border-gray-200 rounded-xl" placeholder="Isi jika ingin mengganti password">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Foto</label>
                    <div class="flex items-center gap-3">
                        <img id="editUserPhotoPreview" src="" alt="preview" class="w-12 h-12 rounded-full object-cover hidden">
                        <div class="flex flex-col">
                            <input type="file" id="editUserPhotoFile" accept="image/*" class="text-sm" />
                        </div>
                        <input type="hidden" id="editUserPhotoHidden" value="">
                    </div>
                </div>
            </div>
            <div class="flex gap-3 mt-8">
                <button type="button" onclick="closeModal('editUserModal')" class="flex-1 px-6 py-3 border border-gray-200 text-gray-700 rounded-xl hover:bg-gray-50 font-medium transition-all duration-200">
                    Batal
                </button>
                <button type="submit" class="flex-1 px-6 py-3 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-xl hover:from-blue-600 hover:to-blue-700 font-medium shadow-lg transition-all duration-200">
                    Update
                </button>
            </div>
        </form>
    </div>
</div>

    <!-- Modal untuk Edit Jenis Service -->
    <div id="editServiceTypeModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl w-full max-w-md shadow-2xl">
            <div class="p-6 border-b border-gray-200">
                <h3 class="text-xl font-semibold text-gray-900">Edit Jenis Service</h3>
            </div>
            <form onsubmit="updateServiceType(event)" class="p-6">
                <input type="hidden" id="editServiceTypeId">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Nama Service</label>
                        <input type="text" id="editServiceTypeName" placeholder="Contoh: Ganti LCD" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-purple-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Deskripsi</label>
                        <textarea id="editServiceTypeDescription" placeholder="Deskripsi jenis service" rows="3" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-purple-500 resize-none"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                        <select id="editServiceTypeStatus" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-purple-500" required>
                            <option value="true">Aktif</option>
                            <option value="false">Nonaktif</option>
                        </select>
                    </div>
                </div>
                <div class="flex gap-3 mt-8">
                    <button type="button" onclick="closeModal('editServiceTypeModal')" class="flex-1 px-6 py-3 border border-gray-200 text-gray-700 rounded-xl hover:bg-gray-50 font-medium transition-all duration-200">
                        Batal
                    </button>
                    <button type="submit" class="flex-1 px-6 py-3 bg-gradient-to-r from-orange-500 to-orange-600 text-white rounded-xl hover:from-orange-600 hover:to-orange-700 font-medium shadow-lg transition-all duration-200">
                        Update
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal untuk Edit Member -->
    <div id="editMemberModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl w-full max-w-md max-h-[90vh] overflow-y-auto shadow-2xl">
            <div class="p-6 border-b border-gray-200">
                <h3 class="text-xl font-semibold text-gray-900">Edit Data Member</h3>
            </div>
            <form onsubmit="updateMember(event)" class="p-6">
                <input type="hidden" id="editMemberId">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Kode Member</label>
                        <input type="text" id="editMemberCode" class="w-full px-4 py-3 border border-gray-200 rounded-xl bg-gray-100 text-gray-600" readonly>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Nama Lengkap</label>
                        <input type="text" id="editMemberName" placeholder="Nama lengkap member" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">No. HP</label>
                        <input type="tel" id="editMemberPhone" placeholder="08123456789" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                        <input type="email" id="editMemberEmail" placeholder="email@example.com (opsional)" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Alamat</label>
                        <textarea id="editMemberAddress" placeholder="Alamat lengkap (opsional)" rows="3" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 resize-none"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                        <select id="editMemberStatus" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" required>
                            <option value="true">Aktif</option>
                            <option value="false">Nonaktif</option>
                        </select>
                    </div>
                </div>
                <div class="flex gap-3 mt-8">
                    <button type="button" onclick="closeModal('editMemberModal')" class="flex-1 px-6 py-3 border border-gray-200 text-gray-700 rounded-xl hover:bg-gray-50 font-medium transition-all duration-200">
                        Batal
                    </button>
                    <button type="submit" class="flex-1 px-6 py-3 bg-gradient-to-r from-orange-500 to-orange-600 text-white rounded-xl hover:from-orange-600 hover:to-orange-700 font-medium shadow-lg transition-all duration-200">
                        Update
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal untuk Edit Pengeluaran -->
    <div id="editExpenseModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl w-full max-w-md max-h-[90vh] overflow-y-auto shadow-2xl">
            <div class="p-6 border-b border-gray-200">
                <h3 class="text-xl font-semibold text-gray-900">Edit Pengeluaran</h3>
            </div>
            <form onsubmit="updateExpense(event)" class="p-6">
                <input type="hidden" id="editExpenseId">
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Tanggal</label>
                            <input type="date" id="editExpenseDate" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-red-500 focus:border-red-500" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Jumlah</label>
                            <input type="number" id="editExpenseAmount" placeholder="0" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-red-500 focus:border-red-500" required>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Kategori</label>
                        <select id="editExpenseCategory" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-red-500 focus:border-red-500" required>
                            <option value="">Pilih Kategori</option>
                            <option value="Spare Parts">Spare Parts</option>
                            <option value="Tools & Equipment">Tools & Equipment</option>
                            <option value="Operational">Operational</option>
                            <option value="Marketing">Marketing</option>
                            <option value="Transportation">Transportation</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Deskripsi</label>
                        <input type="text" id="editExpenseDescription" placeholder="Deskripsi pengeluaran" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-red-500 focus:border-red-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Catatan</label>
                        <textarea id="editExpenseNotes" placeholder="Catatan tambahan (opsional)" rows="3" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-red-500 focus:border-red-500 resize-none"></textarea>
                    </div>
                </div>
                <div class="flex gap-3 mt-8">
                    <button type="button" onclick="closeModal('editExpenseModal')" class="flex-1 px-6 py-3 border border-gray-200 text-gray-700 rounded-xl hover:bg-gray-50 font-medium transition-all duration-200">
                        Batal
                    </button>
                    <button type="submit" class="flex-1 px-6 py-3 bg-gradient-to-r from-orange-500 to-orange-600 text-white rounded-xl hover:from-orange-600 hover:to-orange-700 font-medium shadow-lg transition-all duration-200">
                        Update
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Struk -->
    <div id="receiptModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl w-full max-w-md shadow-2xl">
            <div class="p-6 border-b border-gray-200 no-print">
                <h3 class="text-xl font-semibold text-gray-900">Struk Service</h3>
            </div>
            <div class="p-6">
                <div id="receiptContent" class="receipt">
                    <!-- Receipt content will be generated here -->
                </div>
                <div class="flex gap-3 mt-6 no-print">
                    <button onclick="closeModal('receiptModal')" class="flex-1 px-6 py-3 border border-gray-200 text-gray-700 rounded-xl hover:bg-gray-50 font-medium transition-all duration-200">
                        Tutup
                    </button>
                    <button onclick="printReceipt()" class="flex-1 px-6 py-3 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-xl hover:from-blue-600 hover:to-blue-700 font-medium shadow-lg transition-all duration-200">
                        🖨️ Cetak
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===========================================
        // API CONFIGURATION & MOCK DATA
        // ===========================================
        
        const API_BASE_URL = '/api'; // Since we're serving from same domain

        
        // API Helper Functions with fallback to mock data
        async function apiRequest(endpoint, options = {}) {
            const url = `${API_BASE_URL}${endpoint}`;
            const config = {
                headers: {
                    'Content-Type': 'application/json',
                    ...options.headers
                },
                ...options
            };
            
            if (config.body && typeof config.body === 'object') {
                config.body = JSON.stringify(config.body);
            }
            
            try {
                const response = await fetch(url, config);
                
                // Check if response is HTML (error page) instead of JSON
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    console.warn(`API endpoint ${endpoint} not available, using mock data`);
                    return await mockApiResponse(endpoint, options);
                }
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.message || `HTTP error! status: ${response.status}`);
                }
                
                return data;
            } catch (error) {
                console.warn(`API Error (${endpoint}), falling back to mock data:`, error.message);
                return await mockApiResponse(endpoint, options);
            }
        }
        
        // Mock API responses for development/demo
        // Temporary demo data for when backend API isn't available locally.
        // Remove or replace this with real API data when running the backend.
        let mockServices = [
            {
                id: 1,
                service_date: new Date().toISOString().split('T')[0],
                customer_name: 'Irfan',
                customer_phone: '081234567890',
                service_type: 'Ganti Oli',
                price: 75000,
                payment_status: 'Belum Bayar',
                service_stock_sku: null,
                member_status: 'Non-Member',
                notes: 'Prioritas',
                source: 'jenis'
            },
            {
                id: 2,
                service_date: new Date().toISOString().split('T')[0],
                customer_name: 'Sari',
                customer_phone: '082198765432',
                service_type: 'Ganti Busi',
                price: 120000,
                payment_status: 'Sudah Bayar',
                service_stock_sku: 'SKU-12345',
                member_status: 'Member',
                notes: '',
                source: 'stok'
            }
        ];
let mockExpenses = [];
let mockServiceTypes = [];
let mockMembers = [];
        async function mockApiResponse(endpoint, options = {}) {
            // Simulate network delay
            await new Promise(resolve => setTimeout(resolve, 300));
            
            const method = options.method || 'GET';
            
            switch (endpoint) {
                case '/services':
                        if (method === 'POST') {
                            // options.body may be a JSON string (when apiRequest stringified it)
                            let body = options.body || {};
                            if (typeof body === 'string') {
                                try { body = JSON.parse(body); } catch (e) { body = {}; }
                            }
                            const newService = {
                                id: mockServices.length + 1,
                                ...body,
                                price: parseInt(body.price)
                            };
                            mockServices.unshift(newService);
                            return { success: true, data: newService };
                        }
                    return { success: true, data: mockServices };
                    
                case '/expenses':
                    if (method === 'POST') {
                        const newExpense = {
                            id: mockExpenses.length + 1,
                            ...options.body,
                            amount: parseInt(options.body.amount)
                        };
                        mockExpenses.unshift(newExpense);
                        return { success: true, data: newExpense };
                    }
                    return { success: true, data: mockExpenses };
                    
                case '/service-types':
                    if (method === 'POST') {
                        const newServiceType = {
                            id: mockServiceTypes.length + 1,
                            ...options.body,
                            is_active: true
                        };
                        mockServiceTypes.push(newServiceType);
                        return { success: true, data: newServiceType };
                    }
                    return { success: true, data: mockServiceTypes };
                    
                case '/members':
                    if (method === 'POST') {
                        const newMember = {
                            id: mockMembers.length + 1,
                            code: `MBR${String(mockMembers.length + 1).padStart(3, '0')}`,
                            ...options.body,
                            join_date: new Date().toISOString().split('T')[0],
                            total_services: 0,
                            total_spent: 0,
                            is_active: true
                        };
                        mockMembers.push(newMember);
                        return { success: true, data: newMember };
                    }
                    return { success: true, data: mockMembers };
                    
                case '/dashboard/stats':
                    const today = new Date().toISOString().split('T')[0];
                    const todayServices = mockServices.filter(s => s.service_date === today);
                    const todayExpenses = mockExpenses.filter(e => e.expense_date === today);
                    const unpaidServices = mockServices.filter(s => s.payment_status === 'Belum Bayar');
                    
                    return {
                        success: true,
                        data: {
                            todayIncome: todayServices.reduce((sum, s) => sum + (s.payment_status === 'Sudah Bayar' ? s.price : 0), 0),
                            todayExpense: todayExpenses.reduce((sum, e) => sum + e.amount, 0),
                            todayServices: todayServices.length,
                            totalPiutang: unpaidServices.reduce((sum, s) => sum + s.price, 0)
                        }
                    };
                    
case '/dashboard/report':
case '/report/summary':
    // Ambil parameter tanggal dari endpoint
    let startDate = null, endDate = null;
    if (endpoint.includes('?')) {
        const params = new URLSearchParams(endpoint.split('?')[1]);
        startDate = params.get('startDate');
        endDate = params.get('endDate');
    }
    let filteredServices = mockServices;
    let filteredExpenses = mockExpenses;
    if (startDate && endDate) {
        filteredServices = mockServices.filter(s => s.service_date >= startDate && s.service_date <= endDate);
        filteredExpenses = mockExpenses.filter(e => e.expense_date >= startDate && e.expense_date <= endDate);
    }
    const totalIncome = filteredServices.filter(s => s.payment_status === 'Sudah Bayar').reduce((sum, s) => sum + s.price, 0);
    const totalExpense = filteredExpenses.reduce((sum, e) => sum + e.amount, 0);

    // Group income by service type
    const incomeByType = {};
    filteredServices.filter(s => s.payment_status === 'Sudah Bayar').forEach(s => {
        if (!incomeByType[s.service_type]) {
            incomeByType[s.service_type] = { service_type: s.service_type, total: 0, count: 0 };
        }
        incomeByType[s.service_type].total += s.price;
        incomeByType[s.service_type].count += 1;
    });

    // Group expenses by category
    const expenseByCategory = {};
    filteredExpenses.forEach(e => {
        if (!expenseByCategory[e.category]) {
            expenseByCategory[e.category] = { category: e.category, total: 0, count: 0 };
        }
        expenseByCategory[e.category].total += e.amount;
        expenseByCategory[e.category].count += 1;
    });

    return {
        success: true,
        data: {
            totalIncome,
            totalExpense,
            profit: totalIncome - totalExpense,
            totalServices: filteredServices.length,
            incomeByType: Object.values(incomeByType),
            expenseByCategory: Object.values(expenseByCategory)
        }
    };
                    
                default:
                    if (endpoint.includes('/services/') && endpoint.includes('/payment') && method === 'PUT') {
                        const serviceId = parseInt(endpoint.split('/')[2]);
                        const service = mockServices.find(s => s.id === serviceId);
                        if (service) {
                            service.payment_status = 'Sudah Bayar';
                            return { success: true, data: service };
                        }
                    }
                    
                    if (endpoint.includes('/services/') && method === 'DELETE') {
                        const serviceId = parseInt(endpoint.split('/')[2]);
                        const index = mockServices.findIndex(s => s.id === serviceId);
                        if (index !== -1) {
                            mockServices.splice(index, 1);
                            return { success: true };
                        }
                    }
                    
                    if (endpoint.includes('/expenses/') && method === 'PUT') {
                        const expenseId = parseInt(endpoint.split('/')[2]);
                        const expenseIndex = mockExpenses.findIndex(e => e.id === expenseId);
                        if (expenseIndex !== -1) {
                            mockExpenses[expenseIndex] = { 
                                ...mockExpenses[expenseIndex], 
                                ...options.body,
                                amount: parseInt(options.body.amount)
                            };
                            return { success: true, data: mockExpenses[expenseIndex] };
                        }
                    }
                    
                    if (endpoint.includes('/expenses/') && method === 'DELETE') {
                        const expenseId = parseInt(endpoint.split('/')[2]);
                        const index = mockExpenses.findIndex(e => e.id === expenseId);
                        if (index !== -1) {
                            mockExpenses.splice(index, 1);
                            return { success: true };
                        }
                    }
                    
                    if (endpoint.includes('/service-types/') && method === 'PUT') {
                        const serviceTypeId = parseInt(endpoint.split('/')[2]);
                        const serviceTypeIndex = mockServiceTypes.findIndex(st => st.id === serviceTypeId);
                        if (serviceTypeIndex !== -1) {
                            mockServiceTypes[serviceTypeIndex] = { 
                                ...mockServiceTypes[serviceTypeIndex], 
                                ...options.body
                            };
                            return { success: true, data: mockServiceTypes[serviceTypeIndex] };
                        }
                    }
                    
                    if (endpoint.includes('/members/') && method === 'PUT') {
                        const memberId = parseInt(endpoint.split('/')[2]);
                        const memberIndex = mockMembers.findIndex(m => m.id === memberId);
                        if (memberIndex !== -1) {
                            mockMembers[memberIndex] = { 
                                ...mockMembers[memberIndex], 
                                ...options.body
                            };
                            return { success: true, data: mockMembers[memberIndex] };
                        }
                    }
                    
                    if (endpoint.includes('/service-types/') && method === 'DELETE') {
                        const serviceTypeId = parseInt(endpoint.split('/')[2]);
                        const index = mockServiceTypes.findIndex(st => st.id === serviceTypeId);
                        if (index !== -1) {
                            mockServiceTypes.splice(index, 1);
                            return { success: true };
                        }
                    }
                    
                    if (endpoint.includes('/members/') && method === 'DELETE') {
                        const memberId = parseInt(endpoint.split('/')[2]);
                        const index = mockMembers.findIndex(m => m.id === memberId);
                        if (index !== -1) {
                            mockMembers.splice(index, 1);
                            return { success: true };
                        }
                    }
                    
                    return { success: false, message: 'Endpoint not found' };
            }
        }
        
        // ===========================================
        // GLOBAL VARIABLES
        // ===========================================
        
        let serviceTable, piutangTable, expenseTable, serviceTypesTable, membersTable;
        let servicesData = [];
        let expensesData = [];
        let serviceTypesData = [];
        let membersData = [];
       
        
        // ===========================================
        // UTILITY FUNCTIONS
        // ===========================================
        
        function showLoading() {
            document.getElementById('loadingOverlay').classList.remove('hidden');
        }
        
        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }
        
        function formatCurrency(amount) {
            return 'Rp ' + new Intl.NumberFormat('id-ID').format(amount);
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('id-ID', {
                day: '2-digit',
                month: '2-digit', 
                year: 'numeric'
            });
        }

        function showSuccessMessage(message) {
            const successMsg = document.getElementById('successMessage');
            const successText = document.getElementById('successText');
            successText.textContent = message;
            successMsg.classList.remove('hidden');
            setTimeout(() => {
                successMsg.classList.add('hidden');
            }, 3000);
        }

        function showErrorMessage(message) {
            const errorMsg = document.getElementById('errorMessage');
            const errorText = document.getElementById('errorText');
            errorText.textContent = message;
            errorMsg.classList.remove('hidden');
            setTimeout(() => {
                errorMsg.classList.add('hidden');
            }, 5000);
        }

        function hideSuccessMessage() {
            document.getElementById('successMessage').classList.add('hidden');
        }

        function hideErrorMessage() {
            document.getElementById('errorMessage').classList.add('hidden');
        }
        
        // ===========================================
        // NAVIGATION FUNCTIONS
        // ===========================================
        
        function showSection(sectionId) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Show selected section
            document.getElementById(sectionId).classList.add('active');
            
            // Update navigation buttons
            document.querySelectorAll('.sidebar-nav-btn').forEach(btn => {
                btn.classList.remove('active');
                btn.classList.remove('text-white', 'bg-gradient-to-r', 'from-blue-500', 'to-blue-600', 'shadow-lg');
                btn.classList.add('text-gray-600', 'hover:text-gray-900', 'hover:bg-gray-100');
            });
            
            // Activate current button
            const activeBtn = document.getElementById(`nav-${sectionId}`);
            if (activeBtn) {
                activeBtn.classList.add('active');
                activeBtn.classList.remove('text-gray-600', 'hover:text-gray-900', 'hover:bg-gray-100');
                activeBtn.classList.add('text-white', 'bg-gradient-to-r', 'from-blue-500', 'to-blue-600', 'shadow-lg');
            }
            
            // Update top header title and make header visible on md+
            try {
                const header = document.getElementById('topHeader');
                const title = document.getElementById('topHeaderTitle');
                if (header && title) {
                    header.classList.remove('hidden');
                    // prettify section id to title
                    const mapping = {
                        dashboard: 'Dashboard',
                        service: 'Data Service',
                        piutang: 'Data Piutang',
                        pengeluaran: 'Pengeluaran',
                        laporan: 'Laporan',
                        serviceTypes: 'Jenis Service',
                        members: 'Data Member',
                        users: 'Data User'
                    };
                    title.textContent = mapping[sectionId] || (sectionId.charAt(0).toUpperCase() + sectionId.slice(1));
                }
            } catch (e) {}

                // If stocks section shown, ensure stocks are loaded
                if (sectionId === 'stocks') {
                    // update mapping when stocks section selected
                    document.getElementById('topHeaderTitle').textContent = 'Stok Barang';
                    if (typeof loadStocks === 'function') loadStocks();
                }

            // Load section-specific data
            if (sectionId === 'dashboard') {
                loadDashboardData();
            } else if (sectionId === 'laporan') {
                loadReportData();
            }
        }
        
        // ===========================================
        // MODAL FUNCTIONS
        // ===========================================
        
        function showAddServiceModal() {
            document.getElementById('addServiceModal').classList.remove('hidden');
            document.getElementById('addServiceModal').classList.add('flex');
            // Populate select based on chosen source (default: type)
            const source = document.querySelector('input[name="serviceSource"]:checked');
            const srcVal = source ? source.value : 'type';
            populateServiceTypeOptions(srcVal);
            // ensure radio change updates the select - use onchange assignment to avoid duplicate handlers
            document.querySelectorAll('input[name="serviceSource"]').forEach(r => r.onchange = function(){
                // Do not overwrite existing per-row selections (allow mixing service + sparepart).
                // Instead set a default used for new rows and update the single-item top-level select.
                window._defaultServiceSource = this.value;
                populateServiceTypeOptions(this.value);
            });

            // ensure there's at least one item row
            const container = document.getElementById('serviceItemsContainer');
            if (container && container.children.length === 0) addServiceItemRow();
            // recalc totals in case the prefilled/new row set a price
            try { updateServiceTotal(); } catch (e) {}
        }

        function showAddExpenseModal() {
            document.getElementById('addExpenseModal').classList.remove('hidden');
            document.getElementById('addExpenseModal').classList.add('flex');
        }

        function showAddServiceTypeModal() {
            document.getElementById('addServiceTypeModal').classList.remove('hidden');
            document.getElementById('addServiceTypeModal').classList.add('flex');
        }

        function showAddMemberModal() {
            document.getElementById('addMemberModal').classList.remove('hidden');
            document.getElementById('addMemberModal').classList.add('flex');
        }

        function showAddStockModal() {
            const modal = document.getElementById('addStockModal');
            if (!modal) return;
            // reset fields
            const sku = document.getElementById('stockSku');
            const name = document.getElementById('stockName');
            const category = document.getElementById('stockCategory');
            const qty = document.getElementById('stockQty');
            const price = document.getElementById('stockPrice');
            if (sku) sku.value = '';
            if (name) name.value = '';
            if (category) category.value = '';
            if (qty) qty.value = '0';
            if (price) price.value = '0';
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            // focus first field
            if (sku) sku.focus();
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
            document.getElementById(modalId).classList.remove('flex');
        }
        
        // ===========================================
        // DATA LOADING FUNCTIONS
        // ===========================================
        
        async function loadServicesData() {
            try {
                showLoading();
                const response = await apiRequest('/services');
                if (response.success) {
                    // keep raw flat data for other uses
                    servicesData = response.data;

                    // Group services by customer phone + date (YYYY-MM-DD) for display so multiple
                    // items added in one session appear in a single table row.
                    const groups = {};
                    servicesData.forEach(s => {
                        const dateOnly = (new Date(s.service_date)).toISOString().split('T')[0];
                        const key = `${s.customer_phone}||${dateOnly}`;
                        if (!groups[key]) {
                            groups[key] = {
                                id: s.id, // representative id (first item)
                                service_date: s.service_date,
                                customer_name: s.customer_name,
                                customer_phone: s.customer_phone,
                                items: [s],
                                totalPrice: Number(s.price) || 0,
                                payment_status: s.payment_status
                            };
                        } else {
                            groups[key].items.push(s);
                            groups[key].totalPrice += Number(s.price) || 0;
                        }
                    });

                    const displayData = Object.keys(groups).map(k => {
                        const g = groups[k];
                        return {
                            id: g.id,
                            service_date: g.service_date,
                            customer_name: g.customer_name,
                            customer_phone: g.customer_phone,
                            // expose items for custom renderers
                            items: g.items,
                            // price is the aggregated total for the group
                            price: g.totalPrice,
                            // if any item unpaid, mark group as having unpaid items
                            payment_status: g.items.every(i=> i.payment_status === 'Sudah Bayar') ? 'Sudah Bayar' : 'Belum Bayar'
                        };
                    });

                    if (serviceTable) {
                        serviceTable.clear().rows.add(displayData).draw();
                    }

                    if (piutangTable) {
                        // show only groups that have any unpaid item
                        const piutangDisplay = displayData.filter(g => g.payment_status === 'Belum Bayar');
                        piutangTable.clear().rows.add(piutangDisplay).draw();
                    }
                }
            } catch (error) {
                showErrorMessage('Gagal memuat data service: ' + error.message);
            } finally {
                hideLoading();
            }
        }
        
        async function loadExpensesData() {
            try {
                showLoading();
                const response = await apiRequest('/expenses');
                if (response.success) {
                    expensesData = response.data;
                    if (expenseTable) {
                        expenseTable.clear().rows.add(expensesData).draw();
                    }
                }
            } catch (error) {
                showErrorMessage('Gagal memuat data pengeluaran: ' + error.message);
            } finally {
                hideLoading();
            }
        }
        
        async function loadServiceTypesData() {
            try {
                showLoading();
                const response = await apiRequest('/service-types');
                if (response.success) {
                    serviceTypesData = response.data;
                    if (serviceTypesTable) {
                        serviceTypesTable.clear().rows.add(serviceTypesData).draw();
                    }
                    loadServiceTypesDropdown();
                }
            } catch (error) {
                showErrorMessage('Gagal memuat data jenis service: ' + error.message);
            } finally {
                hideLoading();
            }
        }
        
        async function loadMembersData() {
            try {
                showLoading();
                const response = await apiRequest('/members');
                if (response.success) {
                    membersData = response.data;
                    if (membersTable) {
                        membersTable.clear().rows.add(membersData).draw();
                    }
                }
            } catch (error) {
                showErrorMessage('Gagal memuat data member: ' + error.message);
            } finally {
                hideLoading();
            }
        }
        
        // Chart.js instance
        let monthlyRevenueChartInstance = null;
        let popularServiceChartInstance = null;

        function updateMonthlyRevenueChart(monthlyRevenue) {
            const ctx = document.getElementById('monthlyRevenueChart').getContext('2d');
            if (monthlyRevenueChartInstance) monthlyRevenueChartInstance.destroy();

            // create vertical gradient for the bars
            const grad = ctx.createLinearGradient(0, 0, 0, 220);
            grad.addColorStop(0, 'rgba(59,130,246,0.85)');
            grad.addColorStop(1, 'rgba(59,130,246,0.25)');

            monthlyRevenueChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: monthlyRevenue.map(item => item.month),
                    datasets: [{
                        label: 'Revenue',
                        data: monthlyRevenue.map(item => item.total),
                        backgroundColor: grad,
                        borderColor: 'rgba(59,130,246,1)',
                        borderWidth: 1,
                        borderRadius: 8,
                        maxBarThickness: 40
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(ctx) {
                                    const v = Number(ctx.parsed.y || 0);
                                    return 'Rp ' + v.toLocaleString('id-ID');
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) { return 'Rp ' + Number(value).toLocaleString('id-ID'); }
                            }
                        }
                    }
                }
            });
        }

        function updatePopularServiceChart(popularServices) {
            const ctx = document.getElementById('popularServiceChart').getContext('2d');
            if (popularServiceChartInstance) popularServiceChartInstance.destroy();
            popularServiceChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: popularServices.map(item => item.service_type),
                    datasets: [{
                        label: 'Jumlah Service',
                        data: popularServices.map(item => item.count),
                        backgroundColor: 'rgba(34,197,94,0.7)',
                        borderColor: 'rgba(34,197,94,1)',
                        borderWidth: 2,
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false },
                        tooltip: {}
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        // Stocks Chart (improved: horizontal, sorted top-N, clearer labels and tooltips)
        let stocksChartInstance = null;
        async function updateStocksChart() {
            try {
                const resp = await apiRequest('/stocks');
                if (!resp || !resp.success) return;
                const data = (resp.data || []).map(it => ({
                    id: it.id,
                    sku: it.sku || '',
                    name: it.name || it.nama || it.title || '',
                    qty: Number(it.qty || it.quantity || 0),
                    price: Number(it.price || 0)
                }));

                // Sort by quantity desc and take top N most interesting items
                const TOP_N = 8;
                const sorted = data.slice().sort((a, b) => b.qty - a.qty);
                const top = sorted.slice(0, TOP_N);

                // Friendly labels (prefer short name, fallback to sku)
                const labels = top.map(it => {
                    const source = it.name && it.name.length ? it.name : (it.sku || `#${it.id}`);
                    return source.length > 28 ? source.slice(0, 25) + '...' : source;
                });
                const quantities = top.map(it => it.qty);

                // Dynamic canvas height so bars have enough room
                const ctx = document.getElementById('stocksChart');
                if (!ctx) return;
                // set pixel height: 40px per item (min 120)
                ctx.height = Math.max(120, top.length * 40);
                const chartCtx = ctx.getContext('2d');

                if (stocksChartInstance) stocksChartInstance.destroy();
                // gentle color palette (blue to teal) per bar
                const palette = top.map((_, i) => `hsl(${205 - i * 8} 78% ${55 - i * 2}%)`);

                // plugin to draw value labels at the end of each bar
                const valueLabelPlugin = {
                    id: 'valueLabels',
                    afterDatasetsDraw: function(chart) {
                        const ctx = chart.ctx;
                        chart.data.datasets.forEach((dataset, datasetIndex) => {
                            const meta = chart.getDatasetMeta(datasetIndex);
                            if (!meta || !meta.data) return;
                            meta.data.forEach((bar, i) => {
                                const value = dataset.data[i];
                                const txt = String(value);
                                ctx.save();
                                ctx.font = '600 12px Inter, system-ui, -apple-system, "Segoe UI", Roboto';
                                ctx.textBaseline = 'middle';
                                // bar.x is the end position for horizontal bars
                                const x = bar.x;
                                const y = bar.y;
                                const right = chart.chartArea.right;
                                const padding = 6;
                                const textWidth = ctx.measureText(txt).width;
                                // Decide whether to draw outside or inside the bar
                                if (x + textWidth + padding + 4 < right) {
                                    // draw outside (to the right)
                                    ctx.fillStyle = '#0f172a';
                                    ctx.fillText(txt, x + padding, y);
                                } else {
                                    // draw inside (to the left), use light color for contrast
                                    ctx.fillStyle = '#ffffff';
                                    ctx.fillText(txt, x - textWidth - padding, y);
                                }
                                ctx.restore();
                            });
                        });
                    }
                };

                stocksChartInstance = new Chart(chartCtx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Jumlah Stok',
                            data: quantities,
                            backgroundColor: palette,
                            borderRadius: 8,
                            barThickness: 18
                        }]
                    },
                    plugins: [valueLabelPlugin],
                    options: {
                        indexAxis: 'y', // horizontal bars
                        maintainAspectRatio: false,
                        responsive: true,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    title: function(items) {
                                        const idx = items[0].dataIndex;
                                        return top[idx] && top[idx].name ? top[idx].name : top[idx].sku || '';
                                    },
                                    label: function(item) {
                                        const qty = item.formattedValue;
                                        return `Jumlah: ${qty}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                beginAtZero: true,
                                ticks: { precision: 0 }
                            },
                            y: {
                                ticks: { autoSkip: false }
                            }
                        }
                    }
                });

                // also update totals and detail table (full data)
                updateStocksDetails(data);
            } catch (e) {
                console.debug('updateStocksChart error', e);
            }
        }

        function toggleStocksDetails() {
            const container = document.getElementById('stocksDetailContainer');
            const btn = document.getElementById('stocksDetailToggle');
            if (!container || !btn) return;
            if (container.classList.contains('hidden')) {
                container.classList.remove('hidden');
                btn.textContent = 'Sembunyikan Detail';
            } else {
                container.classList.add('hidden');
                btn.textContent = 'Lihat Detail';
            }
        }

        // DataTable instance for stocks details
        let stocksDetailDataTable = null;
        function updateStocksDetails(data) {
            try {
                const items = (data || []).map(it => ({
                    sku: it.sku || '',
                    barcode: it.barcode || it.barCode || '',
                    name: it.name || '',
                    qty: Number(it.qty || 0),
                    price: Number(it.price || 0),
                    value: Number(it.qty || 0) * Number(it.price || 0)
                }));

                const totalSkus = items.length;
                const totalQty = items.reduce((s, it) => s + it.qty, 0);
                const totalValue = items.reduce((s, it) => s + it.value, 0);

                document.getElementById('stocksTotalSkus').textContent = totalSkus;
                document.getElementById('stocksTotalQty').textContent = totalQty;
                document.getElementById('stocksTotalValue').textContent = formatCurrency(totalValue || 0);

                // Initialize DataTable if possible and not already
                try {
                    if (typeof $ !== 'undefined' && $.fn && $.fn.dataTable && typeof $.fn.dataTable.isDataTable === 'function') {
                        if (!$.fn.dataTable.isDataTable('#stocksDetailTable')) {
                            stocksDetailDataTable = $('#stocksDetailTable').DataTable({
                                data: items,
                                autoWidth: false,
                                columns: [
                                    { data: 'sku', width: '15%' },
                                    { data: 'barcode', width: '20%' },
                                    { data: 'name', width: '30%' },
                                    { data: 'qty', className: 'text-right', width: '10%' },
                                    { data: 'price', className: 'text-right', render: function(d){ return formatCurrency(d); }, width: '12%' },
                                    { data: 'value', className: 'text-right', render: function(d){ return formatCurrency(d); }, width: '13%' }
                                ],
                                pageLength: 5,
                                responsive: true,
                                lengthChange: false,
                                searching: true,
                                language: { url: '//cdn.datatables.net/plug-ins/1.13.7/i18n/id.json' }
                            });
                        } else {
                            // update existing
                            stocksDetailDataTable.clear();
                            stocksDetailDataTable.rows.add(items).draw();
                        }
                        return;
                    }
                } catch (e) {
                    console.debug('DataTable init/update failed', e);
                }

                // Fallback to plain table render
                const tbody = document.getElementById('stocksDetailTbody');
                if (!tbody) return;
                tbody.innerHTML = items.map(it => `
                    <tr>
                        <td class="p-2">${it.sku}</td>
                        <td class="p-2">${it.barcode || ''}</td>
                        <td class="p-2">${it.name}</td>
                        <td class="p-2 text-right">${it.qty}</td>
                        <td class="p-2 text-right">${formatCurrency(it.price)}</td>
                        <td class="p-2 text-right">${formatCurrency(it.value)}</td>
                    </tr>
                `).join('');
            } catch (e) {
                console.debug('updateStocksDetails error', e);
            }
        }

        // Barcode search handler: when user types or barcode scanner sends input, query API and filter/highlight
        (function(){
            const el = document.getElementById('stocksBarcodeSearch');
            if (!el) return;
            let timer = null;
            el.addEventListener('input', function(e){
                const q = (this.value || '').trim();
                if (timer) clearTimeout(timer);
                // small debounce to avoid spamming API; barcode scanners typically send full scan quickly
                timer = setTimeout(async () => {
                    if (!q) {
                        // clear table filter
                        try { if (stocksDetailDataTable) stocksDetailDataTable.search('').draw(); } catch(e){}
                        return;
                    }
                    try {
                        showLoading();
                        const resp = await apiRequest(`/stocks/search?barcode=${encodeURIComponent(q)}`);
                        if (resp && resp.success) {
                            // ensure detail table visible
                            const container = document.getElementById('stocksDetailContainer');
                            if (container && container.classList.contains('hidden')) container.classList.remove('hidden');
                            // highlight or filter DataTable to the found item
                            if (stocksDetailDataTable) {
                                stocksDetailDataTable.search('').draw();
                                // find row index with matching barcode
                                stocksDetailDataTable.columns(1).search('^' + q + '$', true, false).draw();
                            } else {
                                // fallback: just reload dashboard chart/details to include all and then highlight via redraw
                                await updateStocksChart();
                            }
                        } else {
                            showErrorMessage('Barang dengan barcode tersebut tidak ditemukan');
                        }
                    } catch (err) {
                        showErrorMessage('Kesalahan pencarian barcode: ' + err.message);
                    } finally {
                        hideLoading();
                    }
                }, 250);
            });
        })();

        async function loadDashboardData() {
            try {
                const response = await apiRequest('/dashboard/stats');
                if (response.success) {
                    const stats = response.data;
                    document.getElementById('todayIncome').textContent = formatCurrency(stats.todayIncome);
                    document.getElementById('todayExpense').textContent = formatCurrency(stats.todayExpense);
                    document.getElementById('todayServices').textContent = stats.todayServices;
                    document.getElementById('totalPiutang').textContent = formatCurrency(stats.totalPiutang);

                    // Update Monthly Revenue Chart
                    if (stats.monthlyRevenue) {
                        updateMonthlyRevenueChart(stats.monthlyRevenue);
                    }
                    // Update Popular Service Chart
                    if (stats.popularServices) {
                        updatePopularServiceChart(stats.popularServices);
                    }
                    // Update Stocks Chart
                    updateStocksChart();
                }
            } catch (error) {
                showErrorMessage('Gagal memuat statistik dashboard: ' + error.message);
            }
        }
        
        function loadServiceTypesDropdown() {
            populateServiceTypeOptions('type');
        }

        // Populate the serviceType select from either service types or stocks
        async function populateServiceTypeOptions(source) {
            const select = document.getElementById('serviceType');
            if (!select) return;
            // reset select and hidden sku
            select.innerHTML = '<option value="">Pilih Jenis Service</option>';
            document.getElementById('serviceStockSku').value = '';
            // reset stocks map to avoid stale duplicates
            window._stocksMap = {};

            if (source === 'type') {
                // Use already loaded serviceTypesData
                (serviceTypesData || []).forEach(type => {
                    if (type.is_active) {
                        const option = document.createElement('option');
                        option.value = `type::${type.name}`; // prefix to identify source
                        option.textContent = type.name;
                        select.appendChild(option);
                    }
                });
            } else if (source === 'stock') {
                // Load stocks via API and use name + price as option label
                try {
                    const resp = await apiRequest('/stocks');
                    const items = (resp && resp.success && Array.isArray(resp.data)) ? resp.data : [];
                    // keep a simple map of sku->item for quick lookup (reset above)
                    items.forEach(it => {
                        const label = `${it.name} (${it.sku})`;
                        const option = document.createElement('option');
                        option.value = `stock::${it.sku}`; // prefix to identify source
                        option.textContent = label;
                        option.dataset.price = it.price || 0;
                        option.dataset.sku = it.sku || '';
                        select.appendChild(option);
                        window._stocksMap[it.sku] = it;
                    });
                } catch (e) {
                    console.debug('Failed to load stocks for serviceType select', e);
                }
            }

            // Attach change handler to auto-fill price when stock chosen
            select.removeEventListener('change', serviceTypeChangeHandler);
            select.addEventListener('change', serviceTypeChangeHandler);
        }

        // Handler for when serviceType select value changes
        function serviceTypeChangeHandler(e) {
            const val = e.target.value || '';
            const priceEl = document.getElementById('servicePrice');
            const hiddenSku = document.getElementById('serviceStockSku');
            if (val.startsWith('stock::')) {
                const sku = val.split('::')[1];
                const item = (window._stocksMap && window._stocksMap[sku]) ? window._stocksMap[sku] : null;
                if (item) {
                    priceEl.value = Number(item.price || 0);
                    hiddenSku.value = sku;
                } else {
                    priceEl.value = 0;
                    hiddenSku.value = '';
                }
            } else if (val.startsWith('type::')) {
                // For service types, clear hidden SKU and keep price as user-provided
                hiddenSku.value = '';
                priceEl.value = priceEl.value || 0;
            } else {
                hiddenSku.value = '';
            }
        }

        // -------------------------
        // Multi-item (service) helpers
        // -------------------------
        // Template index counter
        window._serviceItemCounter = window._serviceItemCounter || 0;

        function addServiceItemRow(prefill) {
            const container = document.getElementById('serviceItemsContainer');
            if (!container) return;
            const idx = ++window._serviceItemCounter;
            const row = document.createElement('div');
            // add a visual wrapper class so rows match the modal's minimal style
            row.className = 'service-item-row grid grid-cols-12 gap-2 items-center p-3 bg-white/60 dark:bg-gray-800/40 rounded-lg shadow-sm';
            row.dataset.itemIndex = idx;

            row.innerHTML = `
                <!-- Service selector: give more space on md+ so it doesn't feel cramped -->
                <div class="col-span-12 md:col-span-7">
                    <div class="flex items-center gap-3">
                        <select data-item-source class="px-2 py-2 border border-gray-200 rounded-lg text-sm w-28 flex-shrink-0 minimal-select">
                            <option value="type">Service</option>
                            <option value="stock">Sparpate</option>
                        </select>
                        <div class="flex-1 min-w-0">
                            <select data-item-select class="w-full px-3 py-2 border border-gray-200 rounded-xl text-sm min-w-0 minimal-select">
                                <option value="">Pilih Service</option>
                            </select>
                        </div>
                    </div>
                </div>
                <!-- Price input: give it more space so both select and price are comfortable -->
                <div class="col-span-6 md:col-span-4">
                    <input data-item-price type="number" placeholder="Harga" class="w-full px-3 py-2 border border-gray-200 rounded-xl text-sm" />
                </div>
                <!-- per-item payment selector removed: use the global #paymentStatus instead -->
                <div class="col-span-6 md:col-span-1 hidden">
                    <!-- kept hidden for layout compatibility in case it's needed later -->
                    <input type="hidden" data-item-payment value="Belum Bayar" />
                </div>
                <div class="col-span-12 md:col-span-1 text-right flex items-center justify-end">
                    <!-- conditional delete button; hidden by default and shown only when >1 rows -->
                    <button type="button" data-remove-btn class="px-2 py-1 text-sm text-red-600 hidden">×</button>
                </div>
            `;

            container.appendChild(row);
            // refresh delete button visibility after adding
            refreshItemRowDeleteButtons();

            // Populate options into the new select (use per-row source if any, default to global)
            const sel = row.querySelector('[data-item-select]');
            const srcSel = row.querySelector('[data-item-source]');
            const globalDefault = (window._defaultServiceSource || (document.querySelector('input[name="serviceSource"]:checked') ? document.querySelector('input[name="serviceSource"]:checked').value : 'type'));
            if (srcSel) srcSel.value = globalDefault;
            populateOptionsIntoSelect(sel, srcSel ? srcSel.value : globalDefault);

            // When per-row source toggles, repopulate options for this row only
            if (srcSel) {
                srcSel.addEventListener('change', function() {
                    populateOptionsIntoSelect(sel, srcSel.value);
                    // clear selected sku/price if switching to type
                    const priceEl = row.querySelector('[data-item-price]');
                    if (srcSel.value === 'type') {
                        // don't overwrite manual price if user had typed one, but clear sku
                        sel.dataset.sku = '';
                    }
                    updateServiceTotal();
                });
            }

            // wire change handler for option -> price/sku autofill
            sel.addEventListener('change', function(e) {
                const v = (e.target.value || '');
                const priceEl = row.querySelector('[data-item-price]');
                const hiddenSkuEl = row.querySelector('[data-item-sku]');
                if (v.startsWith('stock::')) {
                    const sku = v.split('::')[1];
                    const item = (window._stocksMap && window._stocksMap[sku]) ? window._stocksMap[sku] : null;
                    if (item) {
                        priceEl.value = Number(item.price || 0);
                        // set dataset for SKU on the select
                        sel.dataset.sku = sku;
                    } else {
                        priceEl.value = 0;
                        sel.dataset.sku = '';
                    }
                } else if (v.startsWith('type::')) {
                    sel.dataset.sku = '';
                    // leave price as-is for manual input
                } else {
                    sel.dataset.sku = '';
                }
                // recalc total in case price was autofilled
                try { updateServiceTotal(); } catch (e) {}
            });

            // per-item delete button (conditional)
            const remBtn = row.querySelector('[data-remove-btn]');
            if (remBtn) {
                remBtn.addEventListener('click', function() {
                    row.remove();
                    updateServiceTotal();
                    refreshItemRowDeleteButtons();
                });
            }

            // If prefill provided, set values
            if (prefill) {
                const allOptions = Array.from(sel.options).map(o => o.value);
                // try to find matching option by sku or name
                if (prefill.service_stock_sku) {
                    const v = `stock::${prefill.service_stock_sku}`;
                    if (allOptions.includes(v)) sel.value = v;
                } else if (prefill.service_type) {
                    const v = `type::${prefill.service_type}`;
                    if (allOptions.includes(v)) sel.value = v; else {
                        // fallback: create an option with type::value
                        const option = document.createElement('option'); option.value = `type::${prefill.service_type}`; option.textContent = prefill.service_type; sel.appendChild(option); sel.value = option.value;
                    }
                }
                const priceEl = row.querySelector('[data-item-price]');
                priceEl.value = Number(prefill.price || prefill.estimatedCost || 0);
                const payEl = row.querySelector('[data-item-payment]');
                payEl.value = prefill.payment_status || (prefill.isPaid ? 'Sudah Bayar' : 'Belum Bayar') || 'Belum Bayar';
            }

            // wire live update when price input changes
            const priceInput = row.querySelector('[data-item-price]');
            if (priceInput) {
                priceInput.addEventListener('input', updateServiceTotal);
            }

            // ensure total recalculated after prefill
            updateServiceTotal();

            return row;
        }

        // Remove function removeAllServiceItems - replaced by per-row conditional delete buttons.
        // Helper: toggle visibility of per-row delete buttons (show only when more than one row)
        function refreshItemRowDeleteButtons() {
            const container = document.getElementById('serviceItemsContainer');
            if (!container) return;
            const rows = Array.from(container.querySelectorAll('[data-item-select]')).map(s => s.closest('.service-item-row'));
            const show = rows.length > 1;
            rows.forEach(r => {
                const btn = r.querySelector('[data-remove-btn]');
                if (!btn) return;
                if (show) btn.classList.remove('hidden'); else btn.classList.add('hidden');
            });
        }

        // Update the total price shown in #servicePrice by summing item rows.
        function updateServiceTotal() {
            const container = document.getElementById('serviceItemsContainer');
            const totalEl = document.getElementById('servicePrice');
            if (!totalEl) return;

            const rows = container ? Array.from(container.querySelectorAll('[data-item-price]')) : [];
            if (!rows || rows.length === 0) {
                // no item rows: leave total editable
                totalEl.readOnly = false;
                // don't overwrite if user already typed a value; only clear when explicitly reset
                return;
            }

            // sum row prices
            let total = 0;
            rows.forEach(r => {
                const v = parseFloat(r.value) || 0;
                total += v;
            });

            totalEl.value = total;
            // lock total input when using itemized mode
            totalEl.readOnly = true;
        }

        function populateOptionsIntoSelect(selectEl, sourceOverride) {
            if (!selectEl) return;
            selectEl.innerHTML = '<option value="">Pilih Service</option>';
            // default source radio unless an override provided (per-row source)
            const source = (typeof sourceOverride !== 'undefined') ? { value: sourceOverride } : document.querySelector('input[name="serviceSource"]:checked');
            const srcVal = source ? source.value : 'type';
            if (srcVal === 'type') {
                (serviceTypesData || []).forEach(type => {
                    if (type.is_active) {
                        const option = document.createElement('option');
                        option.value = `type::${type.name}`;
                        option.textContent = type.name;
                        selectEl.appendChild(option);
                    }
                });
            } else {
                // stock
                const respPromise = apiRequest('/stocks').catch(() => ({ success: false, data: [] }));
                respPromise.then(resp => {
                    const items = (resp && resp.success && Array.isArray(resp.data)) ? resp.data : [];
                    items.forEach(it => {
                        const option = document.createElement('option');
                        option.value = `stock::${it.sku}`;
                        option.textContent = `${it.name} (${it.sku})`;
                        option.dataset.price = it.price || 0;
                        option.dataset.sku = it.sku || '';
                        selectEl.appendChild(option);
                        window._stocksMap = window._stocksMap || {};
                        window._stocksMap[it.sku] = it;
                    });
                });
            }
        }

        // Collect service item rows into array of payloads
        function collectServiceItems() {
            const container = document.getElementById('serviceItemsContainer');
            if (!container) return [];
            const rows = Array.from(container.querySelectorAll('[data-item-select]')).map(sel => sel.closest('[data-item-index]'))
                .filter(r => r);
            const items = rows.map(r => {
                const sel = r.querySelector('[data-item-select]');
                const priceEl = r.querySelector('[data-item-price]');
                // payment status is global (single selector #paymentStatus). Per-row payment selector removed.
                const payEl = null;
                const val = sel ? sel.value : '';
                let service_type = '';
                let sku = '';
                if (val.startsWith('stock::')) {
                    sku = val.split('::')[1];
                    const item = (window._stocksMap && window._stocksMap[sku]) ? window._stocksMap[sku] : null;
                    service_type = item ? (item.name || sku) : sku;
                } else if (val.startsWith('type::')) {
                    service_type = val.replace(/^type::/, '') || '';
                } else {
                    service_type = '';
                }
                return {
                    service_type: service_type,
                    price: parseFloat(priceEl.value) || 0,
                    service_stock_sku: sku || null
                };
            }).filter(x => x && x.service_type);
            return items;
        }
        
        // ===========================================
        // FORM HANDLERS
        // ===========================================
        
        async function addService(event) {
            event.preventDefault();
            // prevent duplicate submissions
            if (window._isSubmittingService) return;
            window._isSubmittingService = true;
            const submitBtn = event.target.querySelector('button[type="submit"]');
            if (submitBtn) submitBtn.disabled = true;

            try {
                showLoading();
                
                // Collect base customer info
                const base = {
                    service_date: document.getElementById('serviceDate').value,
                    customer_name: document.getElementById('customerName').value,
                    customer_phone: document.getElementById('customerPhone').value,
                    member_status: document.getElementById('memberStatus').value,
                    notes: document.getElementById('serviceNotes').value
                };

                // Collect itemized services from modal (if any)
                const items = collectServiceItems();

                // If no multi-items, fall back to old single-item form fields
                if (!items || items.length === 0) {
                    const rawVal = document.getElementById('serviceType').value || '';
                    let serviceTypeToSend = '';
                    let skuToSend = '';
                    if (rawVal.startsWith('stock::')) {
                        const sku = rawVal.split('::')[1];
                        skuToSend = sku;
                        const item = (window._stocksMap && window._stocksMap[sku]) ? window._stocksMap[sku] : null;
                        serviceTypeToSend = item ? (item.name || sku) : sku;
                    } else {
                        serviceTypeToSend = rawVal.replace(/^type::/, '') || '';
                    }

                    const formData = Object.assign({}, base, {
                        service_type: serviceTypeToSend,
                        price: parseFloat(document.getElementById('servicePrice').value) || 0,
                        payment_status: document.getElementById('paymentStatus').value
                    });
                    if (skuToSend) formData.service_stock_sku = skuToSend;

                    const response = await apiRequest('/services', {
                        method: 'POST',
                        body: formData
                    });

                    if (!response || !response.success) {
                        const msg = (response && response.message) ? response.message : 'Gagal menambah service — periksa console untuk detail.';
                        showErrorMessage(msg);
                        return;
                    }

                    showSuccessMessage('Service berhasil ditambahkan!');
                    closeModal('addServiceModal');
                    event.target.reset();
                    document.getElementById('serviceDate').value = new Date().toISOString().split('T')[0];
                    generateReceipt(response.data);
                    await loadServicesData();
                    await loadDashboardData();
                } else {
                    // submit one POST per item
                    const results = [];
                    // global payment status selected in the modal
                    const globalPaymentStatus = document.getElementById('paymentStatus').value || 'Belum Bayar';
                    for (const it of items) {
                        const payload = Object.assign({}, base, {
                            service_type: it.service_type,
                            price: Number(it.price) || 0,
                            payment_status: globalPaymentStatus,
                            service_stock_sku: it.service_stock_sku || null
                        });
                        try {
                            const resp = await apiRequest('/services', { method: 'POST', body: payload });
                            if (resp && resp.success) results.push(resp.data);
                            else console.warn('item add failed', resp);
                        } catch (e) {
                            console.warn('item add exception', e);
                        }
                    }

                    if (results.length > 0) {
                        showSuccessMessage('Layanan berhasil ditambahkan!');
                        closeModal('addServiceModal');
                        // reset form and items
                        event.target.reset();
                        document.getElementById('serviceDate').value = new Date().toISOString().split('T')[0];
                        removeAllServiceItems();
                        // Generate aggregated receipt from results (pass full array so receipt is itemized)
                        generateReceipt(results);
                        await loadServicesData();
                        await loadDashboardData();
                    } else {
                        showErrorMessage('Gagal menambahkan layanan. Periksa kembali koneksi atau input.');
                    }
                }
            } catch (error) {
                showErrorMessage('Gagal menambahkan service: ' + error.message);
            } finally {
                hideLoading();
                window._isSubmittingService = false;
                if (submitBtn) submitBtn.disabled = false;
            }
        }

        function generateReceipt(serviceData) {
            const receiptContent = document.getElementById('receiptContent');
            const now = new Date();
            // Normalize to array for easier rendering
            const items = Array.isArray(serviceData) ? serviceData.filter(Boolean) : [serviceData];
            if (!items || items.length === 0) return;

            // Use first item for common customer info; create a receipt number based on timestamp for grouped items
            const first = items[0];
            const receiptNumber = items.length > 1 ? `SRV${String(Date.now()).slice(-6)}` : `SRV${String(first.id).padStart(4, '0')}`;

            // Build items rows
            let rowsHtml = '';
            let total = 0;
            items.forEach(it => {
                const type = it.service_type || (it.service_name || '-') ;
                const sku = it.service_stock_sku ? ` <small class="text-gray-500">(${it.service_stock_sku})</small>` : '';
                const price = Number(it.price) || 0;
                total += price;
                rowsHtml += `
                    <div class="receipt-row" style="display:flex;justify-content:space-between;align-items:center;">
                        <div style="flex:1;min-width:0;" class="service-item-row font-normal text-gray-800">${type}${sku}</div>
                        <div style="margin-left:12px;white-space:nowrap;">${formatCurrency(price)}</div>
                    </div>
                `;
            });

            // Aggregate notes (if any)
            const notes = items.map(it => it.notes).filter(Boolean).join('\n---\n');

            receiptContent.innerHTML = `
                <div class="receipt-header">
                    <div class="receipt-title">HELPDESK94</div>
                    <div>Jl. Husain Jeddawi Baru, Depan Lr 7</div>
                    <div>Telp: 082-291-333-956</div>
                </div>
                
                <div class="receipt-info">
                    <div class="receipt-row">
                        <span>No. Struk:</span>
                        <span>${receiptNumber}</span>
                    </div>
                    <div class="receipt-row">
                        <span>Tanggal:</span>
                        <span>${formatDate(first.service_date || new Date().toISOString().split('T')[0])}</span>
                    </div>
                    <div class="receipt-row">
                        <span>Waktu:</span>
                        <span>${now.toLocaleTimeString('id-ID')}</span>
                    </div>
                </div>
                
                <div class="receipt-separator"></div>
                
                <div class="receipt-info">
                    <div class="receipt-row">
                        <span>Pelanggan:</span>
                        <span>${first.customer_name || '-'}</span>
                    </div>
                    <div class="receipt-row">
                        <span>No. HP:</span>
                        <span>${first.customer_phone || '-'}</span>
                    </div>
                    <div class="receipt-row">
                        <span>Status:</span>
                        <span>${first.member_status || '-'}</span>
                    </div>
                </div>
                
                <div class="receipt-separator"></div>

                ${rowsHtml}

                ${notes ? `<div class="receipt-separator"></div><div style="margin-bottom:6px;font-size:11px;white-space:pre-wrap;">${escapeHtml(notes)}</div>` : ''}

                <div class="receipt-separator"></div>

                <div class="receipt-row receipt-total">
                    <span>TOTAL:</span>
                    <span>${formatCurrency(total)}</span>
                </div>

                <div class="receipt-row">
                    <span>Status Bayar:</span>
                    <span>${items.length === 1 ? (first.payment_status || '-') : (items.every(i=>i.payment_status===items[0].payment_status) ? items[0].payment_status : 'Bervariasi')}</span>
                </div>

                <div class="receipt-footer">
                    <div>Terima kasih atas kepercayaan Anda!</div>
                    <div>Barang yang sudah dibeli tidak dapat dikembalikan</div>
                </div>

                <div class="flex gap-3 mt-6 no-print">
                    <button onclick="closeModal('receiptModal')" class="flex-1 px-6 py-3 border border-gray-200 text-gray-700 rounded-xl hover:bg-gray-50 font-medium transition-all duration-200">
                        Batal
                    </button>
                    <button onclick="printReceipt()" class="flex-1 px-6 py-3 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-xl hover:from-blue-600 hover:to-blue-700 font-medium shadow-lg transition-all duration-200">
                        🖨️ Cetak Struk
                    </button>
                </div>
            `;

            // Show receipt modal
            document.getElementById('receiptModal').classList.remove('hidden');
            document.getElementById('receiptModal').classList.add('flex');
        }

        // Small helper to escape HTML in notes
        function escapeHtml(str) {
            if (!str) return '';
            return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        }

        function printStrukByNamaDanTanggal() {
    const nama = document.getElementById('strukNamaPelanggan').value.trim().toLowerCase();
    const startDate = document.getElementById('strukStartDate').value;
    const endDate = document.getElementById('strukEndDate').value;

    if (!nama || !startDate || !endDate) {
        showErrorMessage('Nama pelanggan dan tanggal harus diisi!');
        return;
    }

    // Filter semua service sesuai nama dan tanggal
    const filtered = servicesData.filter(s =>
        s.customer_name.toLowerCase().includes(nama) &&
        s.service_date >= startDate &&
        s.service_date <= endDate
    );

    if (filtered.length === 0) {
        showErrorMessage('Data service tidak ditemukan untuk filter tersebut!');
        return;
    }

    // Buat struk grup tanpa kolom tanggal
    let totalHarga = 0;
let serviceRows = '';
    filtered.forEach(service => {
    totalHarga += Number(service.price) || 0;
    serviceRows += `
        <tr>
            <td class="service-item-row font-normal">${service.service_type}</td>
            <td>${formatCurrency(service.price)}</td>
            <td>${service.payment_status}</td>
        </tr>
    `;
});

    const receiptContent = document.getElementById('receiptContent');
    receiptContent.innerHTML = `
        <div class="receipt-header">
            <div class="receipt-title">HELPDESK94</div>
            <div>Jl. Husain Jeddawi Baru, Depan Lr 7</div>
            <div>Telp: 082-291-333-956</div>
        </div>
        <div class="receipt-info">
            <div class="receipt-row">
                <span>Pelanggan:</span>
                <span>${filtered[0].customer_name}</span>
            </div>
            <div class="receipt-row">
                <span>No. HP:</span>
                <span>${filtered[0].customer_phone}</span>
            </div>
            <div class="receipt-row">
                <span>Periode:</span>
                <span>${formatDate(startDate)} - ${formatDate(endDate)}</span>
            </div>
        </div>
        <div class="receipt-separator"></div>
        <table style="width:100%;font-size:12px;margin-bottom:10px;">
            <thead>
                <tr>
                    <th>Service</th>
                    <th>Harga</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                ${serviceRows}
            </tbody>
        </table>
        <div class="receipt-row receipt-total">
            <span>TOTAL:</span>
            <span>${formatCurrency(totalHarga)}</span>
        </div>
        <div class="receipt-footer">
            <div>Terima kasih atas kepercayaan Anda!</div>
            <div>Barang yang sudah dibeli tidak dapat dikembalikan</div>
        </div>
        <div class="flex gap-3 mt-6 no-print">
            <button onclick="closeModal('receiptModal')" class="flex-1 px-6 py-3 border border-gray-200 text-gray-700 rounded-xl hover:bg-gray-50 font-medium transition-all duration-200">
                Batal
            </button>
            <button onclick="printReceipt()" class="flex-1 px-6 py-3 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-xl hover:from-blue-600 hover:to-blue-700 font-medium shadow-lg transition-all duration-200">
                🖨️ Cetak Struk
            </button>
        </div>
    `;

    // Tampilkan modal struk
    document.getElementById('receiptModal').classList.remove('hidden');
    document.getElementById('receiptModal').classList.add('flex');
}

        function printReceipt() {
            window.print();
        }

        async function addExpense(event) {
            event.preventDefault();
            
            try {
                showLoading();
                
                const formData = {
                    expense_date: document.getElementById('expenseDate').value,
                    category: document.getElementById('expenseCategory').value,
                    description: document.getElementById('expenseDescription').value,
                    amount: parseInt(document.getElementById('expenseAmount').value),
                    notes: document.getElementById('expenseNotes').value
                };
                
                const response = await apiRequest('/expenses', {
                    method: 'POST',
                    body: formData
                });
                
                if (response.success) {
                    showSuccessMessage('Pengeluaran berhasil ditambahkan!');
                    closeModal('addExpenseModal');
                    event.target.reset();
                    document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
                    
                    // Reload data
                    await loadExpensesData();
                    await loadDashboardData();
                }
            } catch (error) {
                showErrorMessage('Gagal menambahkan pengeluaran: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        async function addServiceType(event) {
            event.preventDefault();
            
            try {
                showLoading();
                
                const formData = {
                    name: document.getElementById('serviceTypeName').value,
                    description: document.getElementById('serviceTypeDescription').value
                };
                
                const response = await apiRequest('/service-types', {
                    method: 'POST',
                    body: formData
                });
                
                if (response.success) {
                    showSuccessMessage('Jenis service berhasil ditambahkan!');
                    closeModal('addServiceTypeModal');
                    event.target.reset();
                    
                    // Reload data
                    await loadServiceTypesData();
                }
            } catch (error) {
                showErrorMessage('Gagal menambahkan jenis service: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        async function addMember(event) {
            event.preventDefault();
            
            try {
                showLoading();
                
                const formData = {
                    name: document.getElementById('memberName').value,
                    phone: document.getElementById('memberPhone').value,
                    email: document.getElementById('memberEmail').value,
                    address: document.getElementById('memberAddress').value
                };
                
                const response = await apiRequest('/members', {
                    method: 'POST',
                    body: formData
                });
                
                if (response.success) {
                    showSuccessMessage('Member berhasil ditambahkan!');
                    closeModal('addMemberModal');
                    event.target.reset();
                    
                    // Reload data
                    await loadMembersData();
                }
            } catch (error) {
                showErrorMessage('Gagal menambahkan member: ' + error.message);
            } finally {
                hideLoading();
            }
        }
        
        // ===========================================
        // ACTION HANDLERS
        // ===========================================
        
        async function markAsPaid(id) {
            try {
                showLoading();
                const response = await apiRequest(`/services/${id}/payment`, {
                    method: 'PUT',
                    body: { payment_status: 'Sudah Bayar' }
                });
                
                if (response.success) {
                    showSuccessMessage('Status pembayaran berhasil diupdate menjadi lunas!');
                    await loadServicesData();
                    await loadDashboardData();
                }
            } catch (error) {
                showErrorMessage('Gagal mengupdate status pembayaran: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        async function deleteService(id) {
            if (confirm('Yakin ingin menghapus data service ini?')) {
                try {
                    showLoading();
                    const response = await apiRequest(`/services/${id}`, {
                        method: 'DELETE'
                    });
                    
                    if (response.success) {
                        showSuccessMessage('Data service berhasil dihapus!');
                        
                        // Update local data
                        const serviceIndex = servicesData.findIndex(s => s.id == id);
                        if (serviceIndex !== -1) {
                            servicesData.splice(serviceIndex, 1);
                            serviceTable.clear().rows.add(servicesData).draw();
                            
                            // Update piutang table if needed
                            const piutangData = servicesData.filter(s => s.payment_status === 'Belum Bayar');
                            piutangTable.clear().rows.add(piutangData).draw();
                        }
                        
                        await loadDashboardData();
                    }
                } catch (error) {
                    showErrorMessage('Gagal menghapus service: ' + error.message);
                } finally {
                    hideLoading();
                }
            }
        }

        // Mark all services for a given phone+date as paid
        async function markGroupAsPaid(phone, dateOnly) {
            if (!confirm('Tandai semua layanan pada tanggal ini sebagai Sudah Bayar?')) return;
            try {
                showLoading();
                // find matching service ids
                const matches = servicesData.filter(s => {
                    const d = (new Date(s.service_date)).toISOString().split('T')[0];
                    return s.customer_phone === phone && d === dateOnly && s.payment_status === 'Belum Bayar';
                });
                for (const m of matches) {
                    await apiRequest(`/services/${m.id}/payment`, { method: 'PUT', body: { payment_status: 'Sudah Bayar' } });
                }
                showSuccessMessage('Semua layanan pada grup ini telah ditandai lunas.');
                await loadServicesData();
                await loadDashboardData();
            } catch (e) {
                showErrorMessage('Gagal menandai grup sebagai lunas: ' + e.message);
            } finally { hideLoading(); }
        }

        // Delete all services for a given phone+date
        async function deleteGroup(phone, dateOnly) {
            if (!confirm('Hapus semua layanan pada grup ini?')) return;
            try {
                showLoading();
                const matches = servicesData.filter(s => {
                    const d = (new Date(s.service_date)).toISOString().split('T')[0];
                    return s.customer_phone === phone && d === dateOnly;
                });
                for (const m of matches) {
                    await apiRequest(`/services/${m.id}`, { method: 'DELETE' });
                }
                showSuccessMessage('Grup layanan berhasil dihapus.');
                await loadServicesData();
                await loadDashboardData();
            } catch (e) {
                showErrorMessage('Gagal menghapus grup: ' + e.message);
            } finally { hideLoading(); }
        }

        async function deleteExpense(id) {
    if (confirm('Yakin ingin menghapus data pengeluaran ini?')) {
        try {
            showLoading();
            const response = await apiRequest(`/expenses/${id}`, {
                method: 'DELETE'
            });
            
            if (response.success) {
                showSuccessMessage('Data pengeluaran berhasil dihapus!');
                
                // Update local data
                const expenseIndex = expensesData.findIndex(e => e.id == id);
                if (expenseIndex !== -1) {
                    expensesData.splice(expenseIndex, 1);
                    expenseTable.clear().rows.add(expensesData).draw();
                }

                // Juga update mockExpenses jika mode mock
                if (typeof mockExpenses !== 'undefined') {
                    const mockIndex = mockExpenses.findIndex(e => e.id == id);
                    if (mockIndex !== -1) {
                        mockExpenses.splice(mockIndex, 1);
                    }
                }
                
                await loadDashboardData();
            }
        } catch (error) {
            showErrorMessage('Gagal menghapus pengeluaran: ' + error.message);
        } finally {
            hideLoading();
        }
    }
}

        async function deleteServiceType(id) {
            if (confirm('Yakin ingin menghapus jenis service ini?')) {
                try {
                    showLoading();
                    const response = await apiRequest(`/service-types/${id}`, {
                        method: 'DELETE'
                    });
                    
                    if (response.success) {
                        showSuccessMessage('Jenis service berhasil dihapus!');
                        
                        // Update local data
                        const serviceTypeIndex = serviceTypesData.findIndex(st => st.id == id);
                        if (serviceTypeIndex !== -1) {
                            serviceTypesData.splice(serviceTypeIndex, 1);
                            serviceTypesTable.clear().rows.add(serviceTypesData).draw();
                            loadServiceTypesDropdown(); // Refresh dropdown
                        }
                    }
                } catch (error) {
                    showErrorMessage('Gagal menghapus jenis service: ' + error.message);
                } finally {
                    hideLoading();
                }
            }
        }

        async function deleteMember(id) {
            if (confirm('Yakin ingin menghapus data member ini?')) {
                try {
                    showLoading();
                    const response = await apiRequest(`/members/${id}`, {
                        method: 'DELETE'
                    });
                    
                    if (response.success) {
                        showSuccessMessage('Data member berhasil dihapus!');
                        
                        // Update local data
                        const memberIndex = membersData.findIndex(m => m.id == id);
                        if (memberIndex !== -1) {
                            membersData.splice(memberIndex, 1);
                            membersTable.clear().rows.add(membersData).draw();
                        }
                    }
                } catch (error) {
                    showErrorMessage('Gagal menghapus member: ' + error.message);
                } finally {
                    hideLoading();
                }
            }
        }

        function editExpense(id) {
            const expense = expensesData.find(e => e.id === id);
            if (expense) {
                // Populate form with existing data
                document.getElementById('editExpenseId').value = expense.id;
                document.getElementById('editExpenseDate').value = expense.expense_date;
                document.getElementById('editExpenseAmount').value = expense.amount;
                document.getElementById('editExpenseCategory').value = expense.category;
                document.getElementById('editExpenseDescription').value = expense.description;
                document.getElementById('editExpenseNotes').value = expense.notes || '';
                
                // Show modal
                document.getElementById('editExpenseModal').classList.remove('hidden');
                document.getElementById('editExpenseModal').classList.add('flex');
            }
        }

        async function updateExpense(event) {
            event.preventDefault();
            
            try {
                showLoading();
                
                const expenseId = document.getElementById('editExpenseId').value;
                const formData = {
                    expense_date: document.getElementById('editExpenseDate').value,
                    category: document.getElementById('editExpenseCategory').value,
                    description: document.getElementById('editExpenseDescription').value,
                    amount: parseInt(document.getElementById('editExpenseAmount').value),
                    notes: document.getElementById('editExpenseNotes').value
                };
                
                const response = await apiRequest(`/expenses/${expenseId}`, {
                    method: 'PUT',
                    body: formData
                });
                
                if (response.success) {
                    showSuccessMessage('Pengeluaran berhasil diupdate!');
                    closeModal('editExpenseModal');
                    
                    // Update local data
                    const expenseIndex = expensesData.findIndex(e => e.id == expenseId);
                    if (expenseIndex !== -1) {
                        expensesData[expenseIndex] = { ...expensesData[expenseIndex], ...formData };
                        expenseTable.clear().rows.add(expensesData).draw();
                    }
                    
                    // Reload dashboard data
                    await loadDashboardData();
                }
            } catch (error) {
                showErrorMessage('Gagal mengupdate pengeluaran: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        function editServiceType(id) {
            const serviceType = serviceTypesData.find(st => st.id === id);
            if (serviceType) {
                // Populate form with existing data
                document.getElementById('editServiceTypeId').value = serviceType.id;
                document.getElementById('editServiceTypeName').value = serviceType.name;
                document.getElementById('editServiceTypeDescription').value = serviceType.description || '';
                document.getElementById('editServiceTypeStatus').value = serviceType.is_active.toString();
                
                // Show modal
                document.getElementById('editServiceTypeModal').classList.remove('hidden');
                document.getElementById('editServiceTypeModal').classList.add('flex');
            }
        }

        async function updateServiceType(event) {
            event.preventDefault();
            
            try {
                showLoading();
                
                const serviceTypeId = document.getElementById('editServiceTypeId').value;
                const formData = {
                    name: document.getElementById('editServiceTypeName').value,
                    description: document.getElementById('editServiceTypeDescription').value,
                    is_active: document.getElementById('editServiceTypeStatus').value === 'true'
                };
                
                const response = await apiRequest(`/service-types/${serviceTypeId}`, {
                    method: 'PUT',
                    body: formData
                });
                
                if (response.success) {
                    showSuccessMessage('Jenis service berhasil diupdate!');
                    closeModal('editServiceTypeModal');
                    
                    // Update local data
                    const serviceTypeIndex = serviceTypesData.findIndex(st => st.id == serviceTypeId);
                    if (serviceTypeIndex !== -1) {
                        serviceTypesData[serviceTypeIndex] = { ...serviceTypesData[serviceTypeIndex], ...formData };
                        serviceTypesTable.clear().rows.add(serviceTypesData).draw();
                        loadServiceTypesDropdown(); // Refresh dropdown
                    }
                }
            } catch (error) {
                showErrorMessage('Gagal mengupdate jenis service: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        function editMember(id) {
            const member = membersData.find(m => m.id === id);
            if (member) {
                // Populate form with existing data
                document.getElementById('editMemberId').value = member.id;
                document.getElementById('editMemberCode').value = member.code;
                document.getElementById('editMemberName').value = member.name;
                document.getElementById('editMemberPhone').value = member.phone;
                document.getElementById('editMemberEmail').value = member.email || '';
                document.getElementById('editMemberAddress').value = member.address || '';
                document.getElementById('editMemberStatus').value = member.is_active.toString();
                
                // Show modal
                document.getElementById('editMemberModal').classList.remove('hidden');
                document.getElementById('editMemberModal').classList.add('flex');
            }
        }

        async function updateMember(event) {
            event.preventDefault();
            
            try {
                showLoading();
                
                const memberId = document.getElementById('editMemberId').value;
                const formData = {
                    name: document.getElementById('editMemberName').value,
                    phone: document.getElementById('editMemberPhone').value,
                    email: document.getElementById('editMemberEmail').value,
                    address: document.getElementById('editMemberAddress').value,
                    is_active: document.getElementById('editMemberStatus').value === 'true'
                };
                
                const response = await apiRequest(`/members/${memberId}`, {
                    method: 'PUT',
                    body: formData
                });
                
                if (response.success) {
                    showSuccessMessage('Data member berhasil diupdate!');
                    closeModal('editMemberModal');
                    
                    // Update local data
                    const memberIndex = membersData.findIndex(m => m.id == memberId);
                    if (memberIndex !== -1) {
                        membersData[memberIndex] = { ...membersData[memberIndex], ...formData };
                        membersTable.clear().rows.add(membersData).draw();
                    }
                }
            } catch (error) {
                showErrorMessage('Gagal mengupdate data member: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // ===========================================
        // STOCKS: load/create/edit/delete (real API)
        // ===========================================

        async function loadStocks() {
            try {
                showLoading();
                const resp = await apiRequest('/stocks');
                if (resp && resp.success) {
                        const items = resp.data || [];
                        // Debug: log raw API data to help diagnose shape mismatches
                        try { console.debug('loadStocks: raw resp.data =', resp.data); } catch (e) {}
                    // Ensure DataTable is initialized with the expected columns before we add rows.
                    try {
                        if (typeof $.fn !== 'undefined' && $.fn.dataTable && typeof $.fn.dataTable.isDataTable === 'function') {
                            if (!$.fn.dataTable.isDataTable('#stocksTable')) {
                                // initialize with same column defs as later in the file
                                window.stocksTable = $('#stocksTable').DataTable({
                                    responsive: true,
                                    pageLength: 10,
                                    language: { url: '//cdn.datatables.net/plug-ins/1.13.7/i18n/id.json' },
                                    columns: [
                                            { data: 'sku' },
                                            { data: 'barcode' },
                                            { data: 'name' },
                                            { data: 'category' },
                                            { data: 'qty' },
                                            { data: 'price', render: function(d){ return formatCurrency(d || 0); } },
                                            { data: null, orderable: false, render: function(data){
                                                return `
                                                    <button onclick="editStock(${data.id})" class="action-btn edit" title="Edit">✏️</button>
                                                    <button onclick="deleteStock(${data.id})" class="action-btn danger" title="Hapus">🗑</button>
                                                `;
                                            }}
                                        ]
                                });
                            } else if (!window.stocksTable) {
                                window.stocksTable = $('#stocksTable').DataTable();
                            }
                        }
                    } catch (e) {
                        console.debug('DataTable init guard failed', e);
                    }

                    // Resolve DataTable API instance (handle cases where window.stocksTable may be a jQuery object or missing)
                    let dt = null;
                    try {
                        if (window.stocksTable && typeof window.stocksTable.clear === 'function') dt = window.stocksTable;
                        else if (window.stocksTable && typeof window.stocksTable.api === 'function') dt = window.stocksTable.api();
                        else if (typeof $('#stocksTable').DataTable === 'function') dt = $('#stocksTable').DataTable();
                    } catch (e) {
                        dt = null;
                    }

                    if (dt && typeof dt.clear === 'function') {
                        // normalize items to plain objects with expected keys to avoid DataTables parameter errors
                        const normalized = (items || []).map(it => ({
                            id: it.id,
                            sku: it.sku || it.SKU || it.code || '',
                            barcode: it.barcode || it.barCode || it.code_bar || '',
                            name: it.name || it.nama || it.title || '',
                            category: it.category || it.kategori || '',
                            qty: (it.qty !== undefined && it.qty !== null) ? Number(it.qty) : (it.quantity !== undefined ? Number(it.quantity) : 0),
                            price: (it.price !== undefined && it.price !== null) ? Number(it.price) : (it.harga !== undefined ? Number(it.harga) : 0)
                        }));

                        dt.clear().rows.add(normalized).draw();
                    } else {
                        // fallback: render simple table using normalized fields
                        const tbody = document.querySelector('#stocksTable tbody');
                        const normalized = (items || []).map(it => ({
                            id: it.id,
                            sku: it.sku || it.SKU || it.code || '',
                            name: it.name || it.nama || it.title || '',
                            category: it.category || it.kategori || '',
                            qty: (it.qty !== undefined && it.qty !== null) ? Number(it.qty) : (it.quantity !== undefined ? Number(it.quantity) : 0),
                            price: (it.price !== undefined && it.price !== null) ? Number(it.price) : (it.harga !== undefined ? Number(it.harga) : 0)
                        }));

                        tbody.innerHTML = normalized.map(it => `
                            <tr>
                                <td>${it.sku}</td>
                                <td>${it.barcode || ''}</td>
                                <td>${it.name}</td>
                                <td>${it.category || ''}</td>
                                <td>${it.qty}</td>
                                <td>${formatCurrency(it.price || 0)}</td>
                                <td>
                                    <button onclick="editStock(${it.id})" class="action-btn edit">✏️</button>
                                    <button onclick="deleteStock(${it.id})" class="action-btn danger">🗑</button>
                                </td>
                            </tr>
                        `).join('');
                    }
                } else {
                    showErrorMessage('Gagal memuat data stok');
                }
            } catch (e) {
                showErrorMessage('Gagal memuat data stok: ' + e.message);
            } finally {
                hideLoading();
            }
        }

        async function addStock(event) {
            event.preventDefault();
            try {
                showLoading();
                const payload = {
                    sku: document.getElementById('stockSku').value.trim(),
                    barcode: document.getElementById('stockBarcode').value.trim(),
                    name: document.getElementById('stockName').value.trim(),
                    category: document.getElementById('stockCategory').value.trim(),
                    qty: parseInt(document.getElementById('stockQty').value || '0'),
                    price: parseFloat(document.getElementById('stockPrice').value || '0')
                };
                const resp = await apiRequest('/stocks', { method: 'POST', body: payload });
                if (resp && resp.success) {
                    showSuccessMessage('Stok berhasil ditambahkan');
                    closeModal('addStockModal');
                    event.target.reset();
                    await loadStocks();
                } else {
                    showErrorMessage('Gagal menambahkan stok: ' + (resp.message || ''));
                }
            } catch (e) {
                showErrorMessage('Gagal menambahkan stok: ' + e.message);
            } finally {
                hideLoading();
            }
        }

        function editStock(id) {
            // fetch single item then populate modal
            showLoading();
            apiRequest(`/stocks/${id}`).then(resp => {
                if (resp && resp.success && resp.data) {
                    const it = resp.data;
                    document.getElementById('editStockId').value = it.id;
                    document.getElementById('editStockSku').value = it.sku;
                    document.getElementById('editStockBarcode').value = it.barcode || '';
                    document.getElementById('editStockName').value = it.name;
                    document.getElementById('editStockCategory').value = it.category || '';
                    document.getElementById('editStockQty').value = it.qty;
                    document.getElementById('editStockPrice').value = it.price || 0;
                    document.getElementById('editStockModal').classList.remove('hidden');
                    document.getElementById('editStockModal').classList.add('flex');
                } else {
                    showErrorMessage('Stok tidak ditemukan');
                }
            }).catch(err => { showErrorMessage('Gagal mengambil data stok: ' + err.message); })
            .finally(() => hideLoading());
        }

        async function updateStock(event) {
            event.preventDefault();
            try {
                showLoading();
                const id = document.getElementById('editStockId').value;
                const payload = {
                    sku: document.getElementById('editStockSku').value.trim(),
                    barcode: document.getElementById('editStockBarcode').value.trim(),
                    name: document.getElementById('editStockName').value.trim(),
                    category: document.getElementById('editStockCategory').value.trim(),
                    qty: parseInt(document.getElementById('editStockQty').value || '0'),
                    price: parseFloat(document.getElementById('editStockPrice').value || '0')
                };
                const resp = await apiRequest(`/stocks/${id}`, { method: 'PUT', body: payload });
                if (resp && resp.success) {
                    showSuccessMessage('Stok berhasil diupdate');
                    closeModal('editStockModal');
                    await loadStocks();
                } else {
                    showErrorMessage('Gagal mengupdate stok: ' + (resp.message || ''));
                }
            } catch (e) {
                showErrorMessage('Gagal mengupdate stok: ' + e.message);
            } finally {
                hideLoading();
            }
        }

        async function deleteStock(id) {
            if (!confirm('Yakin ingin menghapus stok ini?')) return;
            try {
                showLoading();
                const resp = await apiRequest(`/stocks/${id}`, { method: 'DELETE' });
                if (resp && resp.success) {
                    showSuccessMessage('Stok berhasil dihapus');
                    await loadStocks();
                } else {
                    showErrorMessage('Gagal menghapus stok: ' + (resp.message || ''));
                }
            } catch (e) {
                showErrorMessage('Gagal menghapus stok: ' + e.message);
            } finally {
                hideLoading();
            }
        }

        // Search stocks locally on DataTable (guard if element exists)
        const stockSearchEl = document.getElementById('stockSearch');
        if (stockSearchEl) {
            stockSearchEl.addEventListener('input', function() {
                const q = this.value || '';
                try {
                    const dt = (window.stocksTable && typeof window.stocksTable.search === 'function') ? window.stocksTable : ($('#stocksTable').DataTable ? $('#stocksTable').DataTable() : null);
                    if (dt && typeof dt.search === 'function') dt.search(q).draw();
                } catch (e) {
                    // ignore
                }
            });
        }
        
        // ===========================================
        // FILTER FUNCTIONS
        // ===========================================
        
        function filterPiutang() {
            const filter = document.getElementById('piutangFilter').value;
            showSuccessMessage(`Filter piutang berhasil diterapkan: ${filter === 'all' ? 'Semua Status' : filter === 'belum' ? 'Belum Bayar' : 'Sudah Bayar'}`);
        }

        // ...existing code...

async function filterReportByDate() {
    const startDate = document.getElementById('reportStartDate').value;
    const endDate = document.getElementById('reportEndDate').value;

    if (!startDate || !endDate) {
        showErrorMessage('Silakan pilih tanggal mulai dan tanggal akhir!');
        return;
    }

    if (startDate > endDate) {
        showErrorMessage('Tanggal mulai tidak boleh lebih besar dari tanggal akhir!');
        return;
    }

    try {
        showLoading();
        // Endpoint ke backend, bukan mock
        const response = await apiRequest(`/report/summary?startDate=${startDate}&endDate=${endDate}`);
        if (response.success && response.data) {
            const data = response.data;
            document.getElementById('reportIncome').textContent = formatCurrency(data.totalIncome);
            document.getElementById('reportExpense').textContent = formatCurrency(data.totalExpense);
            document.getElementById('reportServices').textContent = data.totalServices;
            const profit = (data.totalIncome || 0) - (data.totalExpense || 0);
            document.getElementById('reportProfit').textContent = formatCurrency(profit);
            const profitElement = document.getElementById('reportProfit');
            profitElement.className = profit >= 0
                ? 'text-base font-bold text-green-600 mt-1'
                : 'text-base font-bold text-red-600 mt-1';
            document.getElementById('reportPeriod').textContent = `${formatDate(startDate)} - ${formatDate(endDate)}`;
            updateDetailedReportFromAPI(data);
            updateCharts(data);
            showSuccessMessage(`Laporan berhasil difilter untuk periode ${formatDate(startDate)} - ${formatDate(endDate)}`);
        } else {
            showErrorMessage('Data laporan tidak ditemukan!');
            updateDetailedReportFromAPI({ incomeByType: [], expenseByCategory: [] });
            updateCharts({ totalIncome: 0, totalExpense: 0, profit: 0, incomeByType: [], expenseByCategory: [] });
        }
    } catch (error) {
        showErrorMessage('Gagal memuat laporan: ' + error.message);
        updateDetailedReportFromAPI({ incomeByType: [], expenseByCategory: [] });
        updateCharts({ totalIncome: 0, totalExpense: 0, profit: 0, incomeByType: [], expenseByCategory: [] });
    } finally {
        hideLoading();
    }
}

async function loadReportData() {
    try {
        // Pastikan endpoint benar
        const response = await apiRequest('/report/summary');
        if (response.success && response.data) {
            const data = response.data;
            document.getElementById('reportIncome').textContent = formatCurrency(data.totalIncome);
            document.getElementById('reportExpense').textContent = formatCurrency(data.totalExpense);
            document.getElementById('reportServices').textContent = data.totalServices;
            const profit = (data.totalIncome || 0) - (data.totalExpense || 0);
            document.getElementById('reportProfit').textContent = formatCurrency(profit);
            const profitElement = document.getElementById('reportProfit');
            profitElement.className = profit >= 0
                ? 'text-base font-bold text-green-600 mt-1'
                : 'text-base font-bold text-red-600 mt-1';
            updateDetailedReportFromAPI(data);
            updateCharts(data);
        } else {
            showErrorMessage('Data laporan tidak ditemukan!');
            updateDetailedReportFromAPI({ incomeByType: [], expenseByCategory: [] });
            updateCharts({ totalIncome: 0, totalExpense: 0, profit: 0, incomeByType: [], expenseByCategory: [] });
        }
    } catch (error) {
        showErrorMessage('Gagal memuat data laporan: ' + error.message);
        updateDetailedReportFromAPI({ incomeByType: [], expenseByCategory: [] });
        updateCharts({ totalIncome: 0, totalExpense: 0, profit: 0, incomeByType: [], expenseByCategory: [] });
    }
}

// ...existing code...

        function updateDetailedReportFromAPI(data) {
            // Update income details
            const incomeDetails = document.getElementById('incomeDetails');
            incomeDetails.innerHTML = '';
            
            if (data.incomeByType && data.incomeByType.length > 0) {
                data.incomeByType.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'flex justify-between items-center p-3 bg-green-50 rounded-lg';
                    div.innerHTML = `
                        <div>
                            <div class="service-item-row font-normal text-green-800">${item.service_type}</div>
                            <div class="text-sm text-green-600">${item.count} service</div>
                        </div>
                        <div class="font-bold text-green-700">${formatCurrency(item.total)}</div>
                    `;
                    incomeDetails.appendChild(div);
                });
            } else {
                incomeDetails.innerHTML = '<div class="text-gray-500 text-center py-4">Tidak ada data pemasukan</div>';
            }

            // Update expense details
            const expenseDetails = document.getElementById('expenseDetails');
            expenseDetails.innerHTML = '';
            
            if (data.expenseByCategory && data.expenseByCategory.length > 0) {
                data.expenseByCategory.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'flex justify-between items-center p-3 bg-red-50 rounded-lg';
                    div.innerHTML = `
                        <div>
                            <div class="font-medium text-red-800">${item.category}</div>
                            <div class="text-sm text-red-600">${item.count} transaksi</div>
                        </div>
                        <div class="font-bold text-red-700">${formatCurrency(item.total)}</div>
                    `;
                    expenseDetails.appendChild(div);
                });
            } else {
                expenseDetails.innerHTML = '<div class="text-gray-500 text-center py-4">Tidak ada data pengeluaran</div>';
            }
        }

        // Chart variables
        let incomeExpenseChart = null;
        let serviceTypeChart = null;

        function updateCharts(data) {
            // Update Income vs Expense Chart
            updateIncomeExpenseChart(data);
            
            // Update Service Type Chart
            updateServiceTypeChart(data);
        }

        function updateIncomeExpenseChart(data) {
            const ctx = document.getElementById('incomeExpenseChart').getContext('2d');
            
            // Destroy existing chart if it exists
            if (incomeExpenseChart) {
                incomeExpenseChart.destroy();
            }
            
            incomeExpenseChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Pemasukan', 'Pengeluaran', 'Laba/Rugi'],
                    datasets: [{
                        label: 'Jumlah (Rp)',
                        data: [data.totalIncome, data.totalExpense, data.profit],
                        backgroundColor: [
                            'rgba(34, 197, 94, 0.8)',   // Green for income
                            'rgba(239, 68, 68, 0.8)',   // Red for expense
                            data.profit >= 0 ? 'rgba(59, 130, 246, 0.8)' : 'rgba(239, 68, 68, 0.8)' // Blue for profit, red for loss
                        ],
                        borderColor: [
                            'rgba(34, 197, 94, 1)',
                            'rgba(239, 68, 68, 1)',
                            data.profit >= 0 ? 'rgba(59, 130, 246, 1)' : 'rgba(239, 68, 68, 1)'
                        ],
                        borderWidth: 2,
                        borderRadius: 8,
                        borderSkipped: false,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return formatCurrency(context.parsed.y);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        function updateServiceTypeChart(data) {
            const ctx = document.getElementById('serviceTypeChart').getContext('2d');
            
            // Destroy existing chart if it exists
            if (serviceTypeChart) {
                serviceTypeChart.destroy();
            }
            
            if (!data.incomeByType || data.incomeByType.length === 0) {
                // Show empty state
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                ctx.font = '16px Inter';
                ctx.fillStyle = '#6b7280';
                ctx.textAlign = 'center';
                ctx.fillText('Tidak ada data service', ctx.canvas.width / 2, ctx.canvas.height / 2);
                return;
            }
            
            // Generate colors for each service type
            const colors = [
                'rgba(59, 130, 246, 0.8)',   // Blue
                'rgba(34, 197, 94, 0.8)',    // Green
                'rgba(251, 191, 36, 0.8)',   // Yellow
                'rgba(239, 68, 68, 0.8)',    // Red
                'rgba(168, 85, 247, 0.8)',   // Purple
                'rgba(236, 72, 153, 0.8)',   // Pink
                'rgba(14, 165, 233, 0.8)',   // Sky
                'rgba(34, 197, 94, 0.8)',    // Emerald
            ];
            
            const borderColors = [
                'rgba(59, 130, 246, 1)',
                'rgba(34, 197, 94, 1)',
                'rgba(251, 191, 36, 1)',
                'rgba(239, 68, 68, 1)',
                'rgba(168, 85, 247, 1)',
                'rgba(236, 72, 153, 1)',
                'rgba(14, 165, 233, 1)',
                'rgba(34, 197, 94, 1)',
            ];
            
            serviceTypeChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: data.incomeByType.map(item => item.service_type),
                    datasets: [{
                        data: data.incomeByType.map(item => item.total),
                        backgroundColor: colors.slice(0, data.incomeByType.length),
                        borderColor: borderColors.slice(0, data.incomeByType.length),
                        borderWidth: 2,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true,
                                font: {
                                    size: 12
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = formatCurrency(context.parsed);
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.parsed / total) * 100).toFixed(1);
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // ===========================================
        // DATATABLE INITIALIZATION
        // ===========================================
        
        $(document).ready(function() {
            // Set default date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('serviceDate').value = today;
            document.getElementById('expenseDate').value = today;
            document.getElementById('reportStartDate').value = today;
            document.getElementById('reportEndDate').value = today;
            
            // Initialize DataTables
            initializeDataTables();
            
            // Load initial data
            loadInitialData();
        });
        
        function initializeDataTables() {
            // Service Table
            serviceTable = $('#serviceTable').DataTable({
                responsive: {
                    details: {
                        renderer: function(api, rowIdx, columns) {
                            // Build a simple table for hidden columns
                            var data = $.map(columns, function(col) {
                                if (col.hidden) {
                                    return '<tr>' +
                                        '<td class="font-medium pr-4" style="white-space:nowrap">' + col.title + ':</td>' +
                                        '<td>' + (col.data || '') + '</td>' +
                                        '</tr>';
                                }
                                return null;
                            }).join('');
                            return data ? $('<table/>').append(data) : false;
                        }
                    }
                },
                autoWidth: false,
                scrollX: false,
                pageLength: 10,
                order: [[0, 'desc']],
                language: {
                    url: '//cdn.datatables.net/plug-ins/1.13.7/i18n/id.json'
                },
                columns: [
                    { 
                        data: 'service_date',
                        responsivePriority: 1,
                        render: function(data) {
                            return formatDate(data);
                        }
                    },
                    { data: 'customer_name', className: 'wrap-cell', width: '18%', responsivePriority: 2 },
                    { 
                        // show one or many service items inside the cell
                        data: 'items',
                        className: 'wrap-cell',
                        width: '28%',
                        responsivePriority: 1,
                        render: function(items, type, row) {
                            if (!items || !items.length) return '';
                            // build stacked list
                            return items.map(it => {
                                const name = it.service_type || '';
                                const sku = it.service_stock_sku ? ` <span class="text-xs text-gray-400">(${it.service_stock_sku})</span>` : '';
                                return `<div class="service-item-row font-normal">${name}${sku}</div>`;
                            }).join('');
                        }
                    },
                    {
                        data: 'items',
                        width: '80px',
                        responsivePriority: 6,
                        render: function(items, type, row) {
                            if (!items || !items.length) return '';
                            // Render one badge per item indicating its source
                            return items.map(it => {
                                const isStock = !!it.service_stock_sku;
                                return `<div style="margin-bottom:4px">${isStock ? '<span class="source-label">Sparpate</span>' : '<span class="source-label">Service</span>'}</div>`;
                            }).join('');
                        }
                    },
                    { data: 'customer_phone', width: '12%', responsivePriority: 5 },
                    { 
                        data: 'price',
                        width: '12%',
                        responsivePriority: 3,
                        className: 'text-right',
                        render: function(data) {
                            return formatCurrency(data);
                        }
                    },
                    { 
                        data: 'payment_status',
                        responsivePriority: 4,
                        render: function(data) {
                            const badgeClass = data === 'Sudah Bayar' ? 'paid' : 'unpaid';
                            return `<span class="status-badge ${badgeClass}">${data}</span>`;
                        }
                    },
                    {
                        data: null,
                        orderable: false,
                        responsivePriority: 1,
                        render: function(data, type, row) {
                            // Actions operate on the whole grouped transaction
                            let actions = '';
                            // mark all items in the group as paid
                            if (row.payment_status === 'Belum Bayar') {
                                actions += `<button onclick="markGroupAsPaid('${row.customer_phone}','${(new Date(row.service_date)).toISOString().split('T')[0]}')" class="action-btn success" title="Tandai Semua Lunas">✓</button>`;
                            }
                            actions += `<button onclick="deleteGroup('${row.customer_phone}','${(new Date(row.service_date)).toISOString().split('T')[0]}')" class="action-btn danger" title="Hapus Grup">🗑</button>`;
                            return actions;
                        }
                    }
                ]
            });
            
            // Piutang Table
            piutangTable = $('#piutangTable').DataTable({
                responsive: {
                    details: {
                        renderer: function(api, rowIdx, columns) {
                            var data = $.map(columns, function(col) {
                                if (col.hidden) {
                                    return '<tr>' +
                                        '<td class="font-medium pr-4" style="white-space:nowrap">' + col.title + ':</td>' +
                                        '<td>' + (col.data || '') + '</td>' +
                                        '</tr>';
                                }
                                return null;
                            }).join('');
                            return data ? $('<table/>').append(data) : false;
                        }
                    }
                },
                autoWidth: false,
                scrollX: false,
                pageLength: 10,
                order: [[0, 'desc']],
                language: {
                    url: '//cdn.datatables.net/plug-ins/1.13.7/i18n/id.json'
                },
                columns: [
                    { 
                        data: 'service_date',
                        responsivePriority: 1,
                        render: function(data) {
                            return formatDate(data);
                        }
                    },
                    { data: 'customer_name', className: 'wrap-cell', width: '18%', responsivePriority: 2 },
                    { 
                        // show stacked list of items without price in piutang table as well
                        data: 'items',
                        className: 'wrap-cell',
                        width: '28%',
                        responsivePriority: 1,
                        render: function(items, type, row) {
                            if (!items || !items.length) return '';
                            return items.map(it => {
                                const name = it.service_type || '';
                                const sku = it.service_stock_sku ? ` <span class="text-xs text-gray-400">(${it.service_stock_sku})</span>` : '';
                                return `<div class="service-item-row font-normal">${name}${sku}</div>`;
                            }).join('');
                        }
                    },
                    {
                        data: 'items',
                        width: '80px',
                        responsivePriority: 6,
                        render: function(items, type, row) {
                            if (!items || !items.length) return '';
                            return items.map(it => {
                                const isStock = !!it.service_stock_sku;
                                return `<div style="margin-bottom:4px">${isStock ? '<span class="source-label">Sparpate</span>' : '<span class="source-label">Service</span>'}</div>`;
                            }).join('');
                        }
                    },
                    { 
                        data: 'price',
                        responsivePriority: 3,
                        render: function(data) {
                            return formatCurrency(data);
                        }
                    },
                    {
                        data: 'service_date',
                        responsivePriority: 4,
                        render: function(data) {
                            const serviceDate = new Date(data);
                            const today = new Date();
                            const diffTime = today - serviceDate;
                            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                            return diffDays > 0 ? `${diffDays} hari` : 'Hari ini';
                        }
                    },
                    {
                        data: null,
                        orderable: false,
                        responsivePriority: 1,
                        render: function(data, type, row) {
                            return `<button onclick="markAsPaid(${row.id})" class="action-btn success" title="Tandai Lunas">💰 Bayar</button>`;
                        }
                    }
                ]
            });
            
            // Expense Table
            expenseTable = $('#expenseTable').DataTable({
                responsive: true,
                pageLength: 10,
                order: [[0, 'desc']],
                language: {
                    url: '//cdn.datatables.net/plug-ins/1.13.7/i18n/id.json'
                },
                columns: [
                    { 
                        data: 'expense_date',
                        render: function(data) {
                            return formatDate(data);
                        }
                    },
                    { data: 'category' },
                    { data: 'description' },
                    { 
                        data: 'amount',
                        render: function(data) {
                            return formatCurrency(data);
                        }
                    },
                    {
                        data: null,
                        orderable: false,
                        render: function(data, type, row) {
                            return `
                                <button onclick="editExpense(${row.id})" class="action-btn edit" title="Edit">✏️</button>
                                <button onclick="deleteExpense(${row.id})" class="action-btn danger" title="Hapus">🗑</button>
                            `;
                        }
                    }
                ]
            });
            
            // Service Types Table
            serviceTypesTable = $('#serviceTypesTable').DataTable({
                responsive: true,
                pageLength: 10,
                language: {
                    url: '//cdn.datatables.net/plug-ins/1.13.7/i18n/id.json'
                },
                columns: [
                    { data: 'id' },
                    { data: 'name' },
                    { data: 'description' },
                    { 
                        data: 'is_active',
                        render: function(data) {
                            const badgeClass = data ? 'active' : 'regular';
                            const text = data ? 'Aktif' : 'Nonaktif';
                            return `<span class="status-badge ${badgeClass}">${text}</span>`;
                        }
                    },
                    {
                        data: null,
                        orderable: false,
                        render: function(data, type, row) {
                            return `
                                <button onclick="editServiceType(${row.id})" class="action-btn edit" title="Edit">✏️</button>
                                <button onclick="deleteServiceType(${row.id})" class="action-btn danger" title="Hapus">🗑</button>
                            `;
                        }
                    }
                ]
            });
            
            // Members Table
            membersTable = $('#membersTable').DataTable({
                responsive: true,
                pageLength: 10,
                language: {
                    url: '//cdn.datatables.net/plug-ins/1.13.7/i18n/id.json'
                },
                columns: [
                    { data: 'code' },
                    { data: 'name' },
                    { 
                        data: null,
                        render: function(data, type, row) {
                            return `${row.phone}<br><small class="text-gray-500">${row.email || '-'}</small>`;
                        }
                    },
                    { 
                        data: 'join_date',
                        render: function(data) {
                            return formatDate(data);
                        }
                    },
                    { data: 'total_services' },
                    { 
                        data: 'total_spent',
                        render: function(data) {
                            return formatCurrency(data);
                        }
                    },
                    { 
                        data: 'is_active',
                        render: function(data) {
                            const badgeClass = data ? 'active' : 'regular';
                            const text = data ? 'Aktif' : 'Nonaktif';
                            return `<span class="status-badge ${badgeClass}">${text}</span>`;
                        }
                    },
                    {
                        data: null,
                        orderable: false,
                        render: function(data, type, row) {
                            return `
                                <button onclick="editMember(${row.id})" class="action-btn edit" title="Edit">✏️</button>
                                <button onclick="deleteMember(${row.id})" class="action-btn danger" title="Hapus">🗑</button>
                            `;
                        }
                    }
                ]
            });
        }
        
        async function loadInitialData() {
            await loadServiceTypesData();
            await loadServicesData();
            await loadExpensesData();
            await loadMembersData();
            await loadDashboardData();
        }
        
        // ===========================================
        // DOWNLOAD REPORT FUNCTIONS
        // ===========================================
        
        // ...existing code...

// ...existing code...

async function downloadReport() {
    try {
        showLoading();

        const startDate = document.getElementById('reportStartDate').value;
        const endDate = document.getElementById('reportEndDate').value;

        let reportData;
        let periodText = 'Semua Waktu';

        if (startDate && endDate) {
            if (startDate > endDate) {
                showErrorMessage('Tanggal mulai tidak boleh lebih besar dari tanggal akhir!');
                return;
            }
            // Pastikan endpoint benar
            const response = await apiRequest(`/report/summary?startDate=${startDate}&endDate=${endDate}`);
            reportData = response.data;
            periodText = `${formatDate(startDate)} - ${formatDate(endDate)}`;
        } else {
            const response = await apiRequest('/report/summary');
            reportData = response.data;
        }

        // Show download options modal
        showDownloadOptionsModal(reportData, periodText);

    } catch (error) {
        showErrorMessage('Gagal memuat data laporan: ' + error.message);
    } finally {
        hideLoading();
    }
}

// ...existing code...// ...existing code...
let usersTable;
let usersData = [];

async function loadUsersData() {
    try {
        showLoading();
    const response = await fetch('/api/users'); // fetch is direct, but apiRequest should use '/users'
        const result = await response.json();
        if (result.success) {
            usersData = result.data;
            if (usersTable) {
                usersTable.clear().rows.add(usersData).draw();
            }
        }
    } catch (error) {
        showErrorMessage('Gagal memuat data user: ' + error.message);
    } finally {
        hideLoading();
    }
}
// Tambah user
async function addUser(event) {
    event.preventDefault();
    try {
        showLoading();
        const formData = {
            name: document.getElementById('userName').value,
            username: document.getElementById('userUsername').value,
            password: document.getElementById('userPassword').value,
            email: document.getElementById('userEmail').value,
            role: document.getElementById('userRole').value,
            is_active: document.getElementById('userStatus').value === 'true'
        };
            // include selected photo if any (from select or upload hidden input)
            const addPhotoSelect = document.getElementById('userPhoto');
            const addPhotoHidden = document.getElementById('userPhotoHidden');
            const selectedPhoto = (addPhotoSelect && addPhotoSelect.value) ? addPhotoSelect.value : (addPhotoHidden ? addPhotoHidden.value : '');
            if (selectedPhoto && String(selectedPhoto).trim() !== '') {
                formData.photo = selectedPhoto;
            }
    // debug: show payload before sending
    console.debug('addUser payload:', formData);
    // send directly so we include credentials and can show real errors
    const resp = await fetch('/api/users', {
            method: 'POST',
            credentials: 'same-origin',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData)
        });
        let response;
        try {
            response = await resp.json();
        } catch (e) {
            throw new Error('Invalid response from server');
        }
        if (resp.ok && response.success) {
            showSuccessMessage('User berhasil ditambahkan!');
            closeModal('addUserModal');
            event.target.reset();
            await loadUsersData();
        } else {
            throw new Error(response.message || 'Gagal menambahkan user');
        }
    } catch (error) {
        showErrorMessage('Gagal menambahkan user: ' + error.message);
    } finally {
        hideLoading();
    }
}

// Hapus user
async function deleteUser(id) {
    if (confirm('Yakin ingin menghapus user ini?')) {
        try {
            showLoading();
            const response = await apiRequest(`/users/${id}`, { method: 'DELETE' });
            if (response.success) {
                showSuccessMessage('User berhasil dihapus!');
                await loadUsersData();
            }
        } catch (error) {
            showErrorMessage('Gagal menghapus user: ' + error.message);
        } finally {
            hideLoading();
        }
    }
}

function editUser(id) {
    const user = usersData.find(u => u.id === id);
    if (user) {
        document.getElementById('editUserId').value = user.id;
        document.getElementById('editUserName').value = user.name;
        document.getElementById('editUserUsername').value = user.username;
        document.getElementById('editUserEmail').value = user.email || '';
        document.getElementById('editUserRole').value = user.role;
        document.getElementById('editUserStatus').value = user.is_active ? 'true' : 'false';
        // reset optional fields
        document.getElementById('editUserPassword').value = '';

    // Populate photo select from server images and set preview if user has photo
    const photoSelect = document.getElementById('editUserPhoto');
    const photoPreview = document.getElementById('editUserPhotoPreview');
    const photoHidden = document.getElementById('editUserPhotoHidden');
    // clear existing options except the first placeholder if select exists
    if (photoSelect) photoSelect.innerHTML = '<option value="">-- Tidak Ada --</option>';
        try {
            fetch('/api/images', { credentials: 'same-origin' })
                .then(res => res.json())
                .then(result => {
                    if (result && result.success && Array.isArray(result.data)) {
                        result.data.forEach(filename => {
                            const opt = document.createElement('option');
                            opt.value = filename;
                            opt.textContent = filename;
                            photoSelect.appendChild(opt);
                        });

                        // set selected photo if user has one
                        if (user.photo) {
                            if (photoSelect) {
                                photoSelect.value = user.photo;
                            }
                            if (photoHidden) photoHidden.value = user.photo;
                            photoPreview.src = `/img/${user.photo}`;
                            photoPreview.classList.remove('hidden');
                        } else {
                            if (photoHidden) photoHidden.value = '';
                            photoPreview.src = '';
                            photoPreview.classList.add('hidden');
                        }
                    }
                })
                .catch(() => {
                    // ignore image list errors; leave select default
                });
        } catch (e) {
            // ignore
        }

        document.getElementById('editUserModal').classList.remove('hidden');
        document.getElementById('editUserModal').classList.add('flex');
    }
}

async function updateUser(event) {
    event.preventDefault();
    try {
        showLoading();
        const userId = document.getElementById('editUserId').value;
        const formData = {
    name: document.getElementById('editUserName').value,
    username: document.getElementById('editUserUsername').value,
    email: document.getElementById('editUserEmail').value,
    role: document.getElementById('editUserRole').value,
    is_active: document.getElementById('editUserStatus').value === 'true'
};
    // include password only if provided
    const newPassword = document.getElementById('editUserPassword').value;
    if (newPassword && newPassword.trim() !== '') {
        formData.password = newPassword;
    }

    // include photo filename only if selected (select or hidden from upload)
    const photoSelectElem = document.getElementById('editUserPhoto');
    const photoHiddenElem = document.getElementById('editUserPhotoHidden');
    const photoValue = (photoSelectElem && photoSelectElem.value) ? photoSelectElem.value : (photoHiddenElem ? photoHiddenElem.value : '');
    if (photoValue && photoValue.trim() !== '') {
        formData.photo = photoValue;
    }

    const response = await apiRequest(`/users/${userId}`, {
            method: 'PUT',
            body: formData
        });
        if (response.success) {
            showSuccessMessage('User berhasil diupdate!');
            closeModal('editUserModal');
            await loadUsersData();
        } else {
            showErrorMessage(response.message || 'User tidak ditemukan atau gagal diupdate!');
        }
    } catch (error) {
        showErrorMessage('Gagal mengupdate user: ' + error.message);
    } finally {
        hideLoading();
    }
}
// Edit user (modal & update handler perlu ditambahkan sesuai kebutuhan)

document.addEventListener('DOMContentLoaded', function() {
    usersTable = $('#usersTable').DataTable({
        responsive: true,
        pageLength: 10,
        language: {
            url: '//cdn.datatables.net/plug-ins/1.13.7/i18n/id.json'
        },
        columns: [
            {
                data: 'photo',
                orderable: false,
                render: function(data, type, row) {
                    if (data) {
                        return `<img src="/img/${data}" class="w-10 h-10 rounded-full object-cover" alt="avatar">`;
                    }
                    // placeholder avatar
                    return `<div class="w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center text-gray-500">👤</div>`;
                }
            },
            { data: 'name' },
            { data: 'username' },
            { data: 'email' },
            { data: 'role' },
            { 
                data: 'is_active',
                render: function(data) {
                    const badgeClass = data ? 'active' : 'regular';
                    const text = data ? 'Aktif' : 'Nonaktif';
                    return `<span class="status-badge ${badgeClass}">${text}</span>`;
                }
            },
            {
                data: 'last_login',
                render: function(data) {
                    if (!data) return '<span class="text-gray-400">Belum Pernah</span>';
                    const d = new Date(data);
                    return d.toLocaleString('id-ID');
                }
            },
            {
                data: null,
                orderable: false,
                render: function(data, type, row) {
                    return `
                        <button onclick="editUser(${row.id})" class="action-btn edit" title="Edit">✏️</button>
                        <button onclick="deleteUser(${row.id})" class="action-btn danger" title="Hapus">🗑</button>
                    `;
                }
            }
        ]
    });
    loadUsersData();

    // live preview when changing photo selection in edit modal
    const editPhotoSelect = document.getElementById('editUserPhoto');
    if (editPhotoSelect) {
        editPhotoSelect.addEventListener('change', function() {
            const preview = document.getElementById('editUserPhotoPreview');
            if (this.value) {
                preview.src = `/img/${this.value}`;
                preview.classList.remove('hidden');
            } else {
                preview.src = '';
                preview.classList.add('hidden');
            }
        });
            
            // Stocks Table
            window.stocksTable = $('#stocksTable').DataTable({
                responsive: true,
                pageLength: 10,
                language: { url: '//cdn.datatables.net/plug-ins/1.13.7/i18n/id.json' },
                columns: [
                    { data: 'sku' },
                    { data: 'name' },
                    { data: 'category' },
                    { data: 'qty' },
                    { data: 'price', render: function(d){ return formatCurrency(d || 0); } },
                    { data: null, orderable: false, render: function(data){
                        return `
                            <button onclick="editStock(${data.id})" class="action-btn edit" title="Edit">✏️</button>
                            <button onclick="deleteStock(${data.id})" class="action-btn danger" title="Hapus">🗑</button>
                        `;
                    }}
                ]
            });
    }
    // live preview for add user photo select
    const addPhotoSelect = document.getElementById('userPhoto');
    if (addPhotoSelect) {
        addPhotoSelect.addEventListener('change', function() {
            const preview = document.getElementById('userPhotoPreview');
            if (this.value) {
                preview.src = `/img/${this.value}`;
                preview.classList.remove('hidden');
            } else {
                preview.src = '';
                preview.classList.add('hidden');
            }
        });
    }

    // Upload file helper
    async function uploadImage(fileInput) {
        if (!fileInput || !fileInput.files || fileInput.files.length === 0) return null;
        const f = fileInput.files[0];
        const fd = new FormData();
        fd.append('file', f);
        try {
            const res = await fetch('/api/upload', { method: 'POST', body: fd, credentials: 'same-origin' });
            const data = await res.json();
            console.debug('uploadImage response:', data);
            if (data && data.success && data.filename) return data.filename;
        } catch (e) {
            console.warn('Upload failed', e);
        }
        return null;
    }

    // Wire file inputs to upload and set select + preview
    const addFileInput = document.getElementById('userPhotoFile');
    if (addFileInput) {
        addFileInput.addEventListener('change', async function() {
            const filename = await uploadImage(this);
            if (filename) {
                try {
                    const select = document.getElementById('userPhoto');
                    // if select exists, add option if not exists and set value
                    if (select) {
                        if (!Array.from(select.options).some(o => o.value === filename)) {
                            const opt = document.createElement('option'); opt.value = filename; opt.text = filename; select.appendChild(opt);
                        }
                        select.value = filename;
                    }
                } catch (e) {
                    console.warn('Could not update photo select', e);
                }
                // always update preview and hidden field regardless of select presence
                const preview = document.getElementById('userPhotoPreview'); if (preview) { preview.src = `/img/${filename}`; preview.classList.remove('hidden'); }
                const hidden = document.getElementById('userPhotoHidden'); if (hidden) { hidden.value = filename; console.debug('userPhotoHidden set to', filename); }
            }
        });
    }

    const editFileInput = document.getElementById('editUserPhotoFile');
    if (editFileInput) {
        editFileInput.addEventListener('change', async function() {
            const filename = await uploadImage(this);
            if (filename) {
                try {
                    const select = document.getElementById('editUserPhoto');
                    if (select) {
                        if (!Array.from(select.options).some(o => o.value === filename)) {
                            const opt = document.createElement('option'); opt.value = filename; opt.text = filename; select.appendChild(opt);
                        }
                        select.value = filename;
                    }
                } catch (e) {
                    console.warn('Could not update edit photo select', e);
                }
                const hidden = document.getElementById('editUserPhotoHidden'); if (hidden) { hidden.value = filename; }
                const preview = document.getElementById('editUserPhotoPreview'); if (preview) { preview.src = `/img/${filename}`; preview.classList.remove('hidden'); }
            }
        });
    }
});

async function downloadReport() {
    try {
        showLoading();

        const startDate = document.getElementById('reportStartDate').value;
        const endDate = document.getElementById('reportEndDate').value;

        let reportData;
        let periodText = 'Semua Waktu';

        if (startDate && endDate) {
            if (startDate > endDate) {
                showErrorMessage('Tanggal mulai tidak boleh lebih besar dari tanggal akhir!');
                return;
            }
            // Pastikan endpoint benar
            const response = await apiRequest(`/report/summary?startDate=${startDate}&endDate=${endDate}`);
            reportData = response.data;
            periodText = `${formatDate(startDate)} - ${formatDate(endDate)}`;
        } else {
            const response = await apiRequest('/report/summary');
            reportData = response.data;
        }

        // Show download options modal
        showDownloadOptionsModal(reportData, periodText);

    } catch (error) {
        showErrorMessage('Gagal memuat data laporan: ' + error.message);
    } finally {
        hideLoading();
    }
}

// ...existing code...

// ...existing code...
        
        function showDownloadOptionsModal(reportData, periodText) {
            const modalHtml = `
                <div id="downloadModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div class="bg-white rounded-2xl w-full max-w-md shadow-2xl">
                        <div class="p-6 border-b border-gray-200">
                            <h3 class="text-xl font-semibold text-gray-900">Download Laporan</h3>
                            <p class="text-sm text-gray-600 mt-1">Pilih format download laporan</p>
                        </div>
                        <div class="p-6">
                            <div class="space-y-3">
                                
                                <button onclick="downloadAsPDF('${periodText}')" class="w-full flex items-center gap-3 p-4 bg-gradient-to-r from-red-50 to-red-100 hover:from-red-100 hover:to-red-200 rounded-xl text-red-700 font-medium transition-all duration-200 transform hover:scale-105">
                                    <span class="text-xl">📄</span>
                                    <div class="text-left">
                                        <div>PDF (.pdf)</div>
                                        <div class="text-sm text-red-600">Format dokumen untuk cetak</div>
                                    </div>
                                </button>
                                <button onclick="downloadAsCSV('${periodText}')" class="w-full flex items-center gap-3 p-4 bg-gradient-to-r from-blue-50 to-blue-100 hover:from-blue-100 hover:to-blue-200 rounded-xl text-blue-700 font-medium transition-all duration-200 transform hover:scale-105">
                                    <span class="text-xl">📋</span>
                                    <div class="text-left">
                                        <div>CSV (.csv)</div>
                                        <div class="text-sm text-blue-600">Format data untuk import</div>
                                    </div>
                                </button>
                            </div>
                            <div class="flex gap-3 mt-6">
                                <button onclick="closeDownloadModal()" class="flex-1 px-6 py-3 border border-gray-200 text-gray-700 rounded-xl hover:bg-gray-50 font-medium transition-all duration-200">
                                    Batal
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal if any
            const existingModal = document.getElementById('downloadModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Add modal to body
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // Store report data globally for download functions
            window.currentReportData = reportData;
        }
        
        function closeDownloadModal() {
            const modal = document.getElementById('downloadModal');
            if (modal) {
                modal.remove();
            }
        }
        
        // ...existing code...

// ...existing code...


// ...existing code...
        
        function downloadAsPDF(periodText) {
            try {
                const reportData = window.currentReportData;
                
                // Create PDF content
                let pdfContent = `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <meta charset="UTF-8">
                        <title>Laporan Keuangan</title>
                        <style>
                            body { font-family: Arial, sans-serif; margin: 20px; font-size: 12px; }
                            .header { text-align: center; margin-bottom: 30px; }
                            .title { font-size: 18px; font-weight: bold; margin-bottom: 10px; }
                            .subtitle { font-size: 14px; color: #666; }
                            .section { margin-bottom: 25px; }
                            .section-title { font-size: 14px; font-weight: bold; margin-bottom: 10px; border-bottom: 1px solid #ccc; padding-bottom: 5px; }
                            table { width: 100%; border-collapse: collapse; margin-bottom: 15px; }
                            th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                            th { background-color: #f5f5f5; font-weight: bold; }
                            .summary-table td:first-child { font-weight: bold; width: 200px; }
                            .text-right { text-align: right; }
                            .text-center { text-align: center; }
                            .profit { color: #059669; }
                            .loss { color: #dc2626; }
                            @media print { body { margin: 0; } }
                        </style>
                    </head>
                    <body>
                        <div class="header">
                            <div class="title">LAPORAN KEUANGAN SERVICE HP</div>
                            <div class="subtitle">Periode: ${periodText}</div>
                            <div class="subtitle">Tanggal Cetak: ${new Date().toLocaleDateString('id-ID')}</div>
                        </div>
                        
                        <div class="section">
                            <div class="section-title">RINGKASAN KEUANGAN</div>
                            <table class="summary-table">
                                <tr><td>Total Pemasukan</td><td class="text-right">${formatCurrency(reportData.totalIncome)}</td></tr>
                                <tr><td>Total Pengeluaran</td><td class="text-right">${formatCurrency(reportData.totalExpense)}</td></tr>
                                <tr><td>Laba/Rugi</td><td class="text-right ${reportData.profit >= 0 ? 'profit' : 'loss'}">${formatCurrency(reportData.profit)}</td></tr>
                                <tr><td>Total Service</td><td class="text-right">${reportData.totalServices}</td></tr>
                            </table>
                        </div>
                        
                        <div class="section">
                            <div class="section-title">PEMASUKAN PER JENIS SERVICE</div>
                            <table>
                                <thead>
                                    <tr>
                                        <th>Jenis Service</th>
                                        <th class="text-center">Jumlah Service</th>
                                        <th class="text-right">Total Pemasukan</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                if (reportData.incomeByType && reportData.incomeByType.length > 0) {
                    reportData.incomeByType.forEach(item => {
                        pdfContent += `
                            <tr>
                                <td class="service-item-row font-normal">${item.service_type}</td>
                                <td class="text-center">${item.count}</td>
                                <td class="text-right">${formatCurrency(item.total)}</td>
                            </tr>
                        `;
                    });
                } else {
                    pdfContent += '<tr><td colspan="3" class="text-center">Tidak ada data pemasukan</td></tr>';
                }
                
                pdfContent += `
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="section">
                            <div class="section-title">PENGELUARAN PER KATEGORI</div>
                            <table>
                                <thead>
                                    <tr>
                                        <th>Kategori</th>
                                        <th class="text-center">Jumlah Transaksi</th>
                                        <th class="text-right">Total Pengeluaran</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                if (reportData.expenseByCategory && reportData.expenseByCategory.length > 0) {
                    reportData.expenseByCategory.forEach(item => {
                        pdfContent += `
                            <tr>
                                <td>${item.category}</td>
                                <td class="text-center">${item.count}</td>
                                <td class="text-right">${formatCurrency(item.total)}</td>
                            </tr>
                        `;
                    });
                } else {
                    pdfContent += '<tr><td colspan="3" class="text-center">Tidak ada data pengeluaran</td></tr>';
                }
                
                pdfContent += `
                                </tbody>
                            </table>
                        </div>
                    </body>
                    </html>
                `;
                
                // Create and download PDF
                const fileName = `Laporan_Keuangan_${periodText.replace(/[^a-zA-Z0-9]/g, '_')}.pdf`;
                downloadHTMLAsPDF(pdfContent, fileName);
                
                closeDownloadModal();
                showSuccessMessage('Laporan PDF berhasil didownload!');
                
            } catch (error) {
                showErrorMessage('Gagal membuat file PDF: ' + error.message);
            }
        }
        
        function downloadAsCSV(periodText) {
            try {
                const reportData = window.currentReportData;
                
                // Create CSV content
                let csvContent = 'LAPORAN KEUANGAN SERVICE HP\n';
                csvContent += `Periode,${periodText}\n`;
                csvContent += `Tanggal Cetak,${new Date().toLocaleDateString('id-ID')}\n\n`;
                
                csvContent += 'RINGKASAN KEUANGAN\n';
                csvContent += 'Keterangan,Jumlah\n';
                csvContent += `Total Pemasukan,${reportData.totalIncome}\n`;
                csvContent += `Total Pengeluaran,${reportData.totalExpense}\n`;
                csvContent += `Laba/Rugi,${reportData.profit}\n`;
                csvContent += `Total Service,${reportData.totalServices}\n\n`;
                
                csvContent += 'PEMASUKAN PER JENIS SERVICE\n';
                csvContent += 'Jenis Service,Jumlah Service,Total Pemasukan\n';
                
                if (reportData.incomeByType && reportData.incomeByType.length > 0) {
                    reportData.incomeByType.forEach(item => {
                        csvContent += `${item.service_type},${item.count},${item.total}\n`;
                    });
                } else {
                    csvContent += 'Tidak ada data,0,0\n';
                }
                
                csvContent += '\nPENGELUARAN PER KATEGORI\n';
                csvContent += 'Kategori,Jumlah Transaksi,Total Pengeluaran\n';
                
                if (reportData.expenseByCategory && reportData.expenseByCategory.length > 0) {
                    reportData.expenseByCategory.forEach(item => {
                        csvContent += `${item.category},${item.count},${item.total}\n`;
                    });
                } else {
                    csvContent += 'Tidak ada data,0,0\n';
                }
                
                // Download CSV
                const fileName = `Laporan_Keuangan_${periodText.replace(/[^a-zA-Z0-9]/g, '_')}.csv`;
                downloadFile(csvContent, fileName, 'text/csv;charset=utf-8;');
                
                closeDownloadModal();
                showSuccessMessage('Laporan CSV berhasil didownload!');
                
            } catch (error) {
                showErrorMessage('Gagal membuat file CSV: ' + error.message);
            }
        }
        
        // Helper functions for file download
        function downloadFile(content, fileName, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }
        
        function downloadHTMLAsPDF(htmlContent, fileName) {
            // Create a new window for PDF generation
            const printWindow = window.open('', '_blank');
            printWindow.document.write(htmlContent);
            printWindow.document.close();
            
            // Wait for content to load then print
            printWindow.onload = function() {
                setTimeout(() => {
                    printWindow.print();
                    printWindow.close();
                }, 500);
            };
        }
        
        // Simple Excel generation functions
        function arrayToSheet(data) {
            const sheet = {};
            const range = { s: { c: 0, r: 0 }, e: { c: 0, r: 0 } };
            
            for (let R = 0; R < data.length; R++) {
                for (let C = 0; C < (data[R] || []).length; C++) {
                    if (range.s.r > R) range.s.r = R;
                    if (range.s.c > C) range.s.c = C;
                    if (range.e.r < R) range.e.r = R;
                    if (range.e.c < C) range.e.c = C;
                    
                    const cell = { v: data[R][C] };
                    if (cell.v == null) continue;
                    
                    const cell_ref = encodeCell({ c: C, r: R });
                    
                    if (typeof cell.v === 'number') cell.t = 'n';
                    else if (typeof cell.v === 'boolean') cell.t = 'b';
                    else if (cell.v instanceof Date) {
                        cell.t = 'n';
                        cell.z = 'mm/dd/yy';
                        cell.v = dateToSerial(cell.v);
                    } else cell.t = 's';
                    
                    sheet[cell_ref] = cell;
                }
            }
            
            if (range.s.c < 10000000) sheet['!ref'] = encodeRange(range);
            return sheet;
        }
        
        function encodeCell(cell) {
            return String.fromCharCode(65 + cell.c) + (cell.r + 1);
        }
        
        function encodeRange(range) {
            return encodeCell(range.s) + ':' + encodeCell(range.e);
        }
        
        function dateToSerial(date) {
            return (date.getTime() - new Date(1900, 0, 1).getTime()) / (24 * 60 * 60 * 1000) + 1;
        }
        
        function writeExcel(wb) {
            // Simple XLSX generation - in a real app, use a library like SheetJS
            // For demo purposes, we'll convert to CSV format
            let output = '';
            
            wb.SheetNames.forEach((sheetName, index) => {
                if (index > 0) output += '\n\n';
                output += `=== ${sheetName} ===\n`;
                
                const sheet = wb.Sheets[sheetName];
                const range = sheet['!ref'];
                if (!range) return;
                
                const [start, end] = range.split(':');
                const startCol = start.charCodeAt(0) - 65;
                const startRow = parseInt(start.slice(1)) - 1;
                const endCol = end.charCodeAt(0) - 65;
                const endRow = parseInt(end.slice(1)) - 1;
                
                for (let r = startRow; r <= endRow; r++) {
                    const row = [];
                    for (let c = startCol; c <= endCol; c++) {
                        const cellRef = String.fromCharCode(65 + c) + (r + 1);
                        const cell = sheet[cellRef];
                        row.push(cell ? cell.v : '');
                    }
                    output += row.join(',') + '\n';
                }
            });
            
            return output;
        }
    
    </script>
    <script>
        function toggleSidebar() {
    const sidebar = document.getElementById('sidebarMenu');
    const overlay = document.getElementById('sidebarOverlay');
    const isActive = sidebar.classList.contains('active');
    if (isActive) {
        sidebar.classList.remove('active');
        overlay.classList.remove('active');
    } else {
        sidebar.classList.add('active');
        overlay.classList.add('active');
    }
}
document.getElementById('sidebarOverlay').onclick = function() {
    toggleSidebar();
};
        // Tidy nav spacing: reduce vertical gaps and button padding
        (function(){
            try {
                var css = '#sidebarMenu .sidebar-nav > .px-4 { padding-top: 0.5rem; padding-bottom: 0.5rem; } ' +
                          '#sidebarMenu .sidebar-nav-btn { padding-top: 0.5rem !important; padding-bottom: 0.5rem !important; }';
                var s = document.createElement('style');
                s.type = 'text/css';
                s.appendChild(document.createTextNode(css));
                document.head.appendChild(s);
            } catch (e) {
                // ignore
            }
        })();
// currentUser harus di-set dari backend setelah login
// window.currentUser = { name: 'Nama User Demo', role: 'admin' };

function logout() {
    // Hapus session/token jika ada, lalu redirect ke halaman login
    window.location.href = '/index.html';
}
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9760ab21f69afdfb',t:'MTc1NjM1MTE4MS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
